<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DupeCleaner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @font-face { font-family:'GoogleSans'; src:url('GoogleSans-Regular.ttf') format('truetype'); font-weight:400; }
    @font-face { font-family:'GoogleSans'; src:url('GoogleSans-Bold.ttf')    format('truetype'); font-weight:700; }
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap');

    /* â”€â”€ LIGHT (default) â”€â”€ */
    :root {
      --bg:       #f5f5f5;
      --panel:    #ffffff;
      --border:   #e2e2e2;
      --border2:  #d0d0d0;
      --dim:      #c0c0c0;
      --muted:    #999;
      --white:    #1a1a1a;
      --red:      #e8002d;
      --red-dim:  rgba(232,0,45,0.07);
      --feed-bg:  #fafafa;
      --code-bg:  #f0f0f0;
      --shadow:   0 1px 4px rgba(0,0,0,.08);
    }
    /* â”€â”€ DARK â”€â”€ */
    body.dark {
      --bg:      #050505;
      --panel:   #0a0a0a;
      --border:  #1a1a1a;
      --border2: #2a2a2a;
      --dim:     #333;
      --muted:   #666;
      --white:   #f0f0f0;
      --red:     #ff0033;
      --red-dim: rgba(255,0,51,0.08);
      --feed-bg: #060606;
      --code-bg: #060606;
      --shadow:  none;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; overflow:hidden; background:var(--bg); color:var(--white); font-family:'GoogleSans',sans-serif; transition:background .25s,color .25s; }

    /* â”€â”€ NAV â”€â”€ */
    nav {
      height:52px; display:flex; align-items:center; justify-content:space-between;
      padding:0 22px; background:var(--panel); border-bottom:1px solid var(--border);
      box-shadow:var(--shadow); z-index:100; position:relative;
    }
    .logo { font-family:'Fira Code',monospace; font-size:1.25rem; font-weight:700; color:var(--white); }
    .logo span { color:var(--red); }
    .nav-right { display:flex; align-items:center; gap:8px; }
    .nav-folder {
      font-family:'Fira Code',monospace; font-size:.7rem; color:var(--muted);
      border:1px solid var(--border); padding:3px 10px; border-radius:4px;
      max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      background:var(--bg);
    }
    .nav-folder i { color:var(--red); margin-right:5px; }

    /* small nav buttons */
    .nbtn {
      background:transparent; border:1px solid var(--border2); color:var(--muted);
      padding:5px 12px; border-radius:4px; font-family:'Fira Code',monospace;
      font-size:.72rem; cursor:pointer; transition:all .2s; display:none; white-space:nowrap;
    }
    .nbtn:hover { border-color:var(--red); color:var(--red); background:var(--red-dim); }
    #btn-stop { border-color:var(--red); color:var(--red); }
    #btn-stop:hover { background:var(--red-dim); }

    /* icon-only toggle buttons */
    .icon-btn {
      background:transparent; border:1px solid var(--border2); color:var(--muted);
      width:32px; height:32px; border-radius:4px; font-size:.82rem; cursor:pointer;
      display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0;
    }
    .icon-btn:hover { border-color:var(--red); color:var(--red); background:var(--red-dim); }

    /* lang switch */
    .lang-switch {
      cursor:pointer; color:var(--muted); font-size:.75rem;
      display:flex; align-items:center; gap:5px; font-family:'Fira Code',monospace;
      border:1px solid var(--border2); padding:4px 10px; border-radius:4px; transition:.3s; background:transparent; white-space:nowrap;
    }
    .lang-switch:hover { color:var(--red); border-color:var(--red); background:var(--red-dim); }

    /* â”€â”€ PROGRESS â”€â”€ */
    #pbar-wrap { height:2px; background:var(--border); flex-shrink:0; }
    #pbar { height:100%; background:var(--red); width:0%; transition:width .25s ease; box-shadow:0 0 8px var(--red); }

    /* â”€â”€ LAYOUT â”€â”€ */
    .app-body   { display:flex; flex-direction:column; height:calc(100vh - 54px); }
    .panels-row { flex:1; display:flex; overflow:hidden; }
    .panel      { display:flex; flex-direction:column; overflow:hidden; min-width:100px; }

    /* â”€â”€ PANEL HEADER â”€â”€ */
    .ph {
      height:36px; flex-shrink:0; display:flex; align-items:center; justify-content:space-between;
      padding:0 14px; background:var(--panel); border-bottom:1px solid var(--border);
      font-family:'GoogleSans',sans-serif; font-size:.82rem; font-weight:700; color:var(--white);
    }
    .ph-l { display:flex; align-items:center; gap:8px; overflow:hidden; }
    .ph-l span { white-space:nowrap; }
    .ph-sub { font-family:'Fira Code',monospace; font-size:.58rem; color:var(--muted); font-weight:400; white-space:nowrap; }
    .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
    .d-idle { background:var(--dim); }
    .d-run  { background:var(--red); animation:blink 1s infinite; }
    .d-stop { background:var(--muted); animation:none; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.15} }
    #scan-lbl { font-weight:700; }
    .badge { background:var(--red); color:#fff; border-radius:10px; padding:1px 8px; font-size:.67rem; font-family:'Fira Code',monospace; font-weight:700; flex-shrink:0; }
    .badge.z { background:var(--dim); color:var(--muted); }

    /* â”€â”€ DIVIDERS â”€â”€ */
    .divider { width:5px; flex-shrink:0; background:transparent; cursor:col-resize; position:relative; z-index:20; transition:background .15s; user-select:none; }
    .divider:hover,.divider.drag { background:var(--red); }
    .divider::after { content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:1px; height:40px; background:var(--border2); }

    /* â”€â”€ LEFT PANEL â”€â”€ */
    #panel-left { width:260px; border-right:1px solid var(--border); }
    #feed { flex:1; overflow:hidden; padding:8px 12px; font-family:'Fira Code',monospace; font-size:.67rem; line-height:1.8; background:var(--feed-bg); }
    .fl { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .fl-dir   { color:var(--white); opacity:.85; }
    .fl-file  { color:var(--muted); }
    .fl-skip  { color:var(--dim); font-style:italic; }
    .fl-match { color:var(--red); font-weight:700; }
    .fl-info  { color:var(--dim); }
    .fl-ok    { color:var(--white); font-weight:700; }
    .fl-err   { color:var(--red); }

    /* â”€â”€ MID PANEL â”€â”€ */
    #panel-mid { flex:1; border-right:1px solid var(--border); }
    #dupes-scroll { flex:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--red) transparent; }
    #dupes-scroll::-webkit-scrollbar { width:5px; }
    #dupes-scroll::-webkit-scrollbar-thumb { background:var(--red); border-radius:3px; }

    /* â”€â”€ HOME â”€â”€ */
    #home { height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:40px; text-align:center; }
    .home-icon { font-size:2.6rem; color:var(--red); opacity:.25; }
    #home h2 { font-size:1.35rem; font-weight:700; color:var(--white); }
    #home p  { color:var(--muted); font-size:.85rem; line-height:1.75; max-width:320px; }
    .home-note { font-family:'Fira Code',monospace; font-size:.65rem; color:var(--dim); }
    .home-warn {
      font-family:'Fira Code',monospace; font-size:.63rem; color:var(--red);
      border:1px solid rgba(232,0,45,.3); background:var(--red-dim);
      padding:7px 14px; border-radius:4px; max-width:340px; line-height:1.7;
    }

    /* â”€â”€ CONFIRM â”€â”€ */
    #confirm-step { display:none; height:100%; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:40px; text-align:center; }
    #confirm-step h3 { font-size:1.1rem; font-weight:700; }
    #confirm-step p  { color:var(--muted); font-size:.83rem; line-height:1.7; max-width:320px; }
    .confirm-path { font-family:'Fira Code',monospace; font-size:.78rem; color:var(--red); background:var(--red-dim); border:1px solid rgba(232,0,45,.25); padding:8px 16px; border-radius:4px; max-width:380px; word-break:break-all; }
    .confirm-btns { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }

    /* â”€â”€ BUTTONS â”€â”€ */
    .btn-primary   { display:inline-flex; align-items:center; gap:8px; padding:10px 20px; background:var(--red); border:1px solid var(--red); color:#fff; font-family:'Fira Code',monospace; font-size:.85rem; cursor:pointer; border-radius:4px; transition:all .2s; }
    .btn-primary:hover   { opacity:.88; transform:translateY(-1px); }
    .btn-secondary { display:inline-flex; align-items:center; gap:8px; padding:10px 20px; background:transparent; border:1px solid var(--border2); color:var(--muted); font-family:'Fira Code',monospace; font-size:.85rem; cursor:pointer; border-radius:4px; transition:all .2s; }
    .btn-secondary:hover { border-color:var(--white); color:var(--white); }

    /* â”€â”€ DUPLICATE GROUPS â”€â”€ */
    .dg { margin:8px 10px; border:1px solid var(--border); border-radius:4px; overflow:hidden; animation:si .25s ease; box-shadow:var(--shadow); }
    @keyframes si { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:none} }
    .dg-hdr { background:var(--red-dim); padding:6px 13px; border-bottom:1px solid var(--border); font-family:'Fira Code',monospace; font-size:.68rem; color:var(--muted); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .dg-hdr .h  { color:var(--red); }
    .dg-hdr .sv { color:var(--white); font-weight:700; white-space:nowrap; }
    .df { padding:8px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:9px; transition:background .1s; }
    .df:last-child { border-bottom:none; }
    .df:hover  { background:var(--red-dim); }
    .df.sel    { background:var(--red-dim); border-left:3px solid var(--red); }
    .df.orig   { border-left:3px solid var(--dim); }
    .df input[type=checkbox] { accent-color:var(--red); width:14px; height:14px; flex-shrink:0; cursor:pointer; }
    .df input[type=checkbox]:disabled { opacity:.25; }
    .df-icon   { font-size:.85rem; color:var(--dim); flex-shrink:0; }
    .df-info   { flex:1; min-width:0; }
    .df-name   { font-size:.83rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--white); }
    .df-path   { font-size:.63rem; color:var(--muted); font-family:'Fira Code',monospace; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .orig-tag  { font-size:.58rem; color:var(--red); border:1px solid var(--red); padding:0 4px; border-radius:2px; margin-left:6px; opacity:.6; vertical-align:middle; }
    .btn-eye   { background:transparent; border:1px solid var(--border); color:var(--dim); padding:3px 8px; border-radius:3px; font-size:.7rem; cursor:pointer; transition:all .18s; flex-shrink:0; }
    .btn-eye:hover { border-color:var(--red); color:var(--red); }

    /* â”€â”€ STATS BAR â”€â”€ */
    #stats-bar { min-height:40px; flex-shrink:0; display:flex; align-items:center; flex-wrap:wrap; gap:4px; padding:0 10px; border-top:1px solid var(--border); background:var(--panel); font-family:'Fira Code',monospace; font-size:.68rem; color:var(--muted); box-shadow:var(--shadow); }
    .sbar-left   { display:flex; align-items:center; gap:6px; }
    .sbar-center { flex:1; display:flex; align-items:center; justify-content:center; min-width:0; }
    .sbar-right  { display:flex; align-items:center; gap:5px; }
    .sbar-val    { color:var(--white); font-weight:700; }
    .sbar-sep    { color:var(--dim); }
    #sel-info    { display:none; font-family:'Fira Code',monospace; font-size:.68rem; color:var(--red); font-weight:700; }
    .sbar-btn { background:transparent; border:1px solid var(--border2); color:var(--muted); padding:3px 9px; border-radius:3px; font-family:'Fira Code',monospace; font-size:.64rem; cursor:pointer; transition:all .18s; white-space:nowrap; }
    .sbar-btn:hover { border-color:var(--white); color:var(--white); }
    #btn-del { background:var(--red); border:1px solid var(--red); color:#fff; padding:3px 10px; border-radius:3px; font-family:'Fira Code',monospace; font-size:.64rem; cursor:pointer; transition:all .18s; display:none; white-space:nowrap; }
    #btn-del:hover { opacity:.85; }

    /* â”€â”€ RIGHT PANEL â”€â”€ */
    #panel-right  { width:290px; }
    #prev-body    { flex:1; overflow:hidden; display:flex; flex-direction:column; }
    #prev-empty   { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; color:var(--dim); font-size:.8rem; text-align:center; }
    #prev-empty i { font-size:2.2rem; }
    #prev-content { flex:1; overflow-y:auto; padding:14px; display:none; scrollbar-width:thin; scrollbar-color:var(--border2) transparent; }
    #prev-content::-webkit-scrollbar       { width:4px; }
    #prev-content::-webkit-scrollbar-thumb { background:var(--border2); border-radius:2px; }
    .pv-name { font-size:.9rem; font-weight:700; word-break:break-all; margin-bottom:4px; color:var(--white); }
    .pv-meta { font-family:'Fira Code',monospace; font-size:.63rem; color:var(--muted); margin-bottom:12px; line-height:1.7; }
    .pv-meta .ac { color:var(--red); font-weight:700; }
    #btn-close-prev { background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:.78rem; padding:3px 5px; border-radius:3px; transition:color .15s; line-height:1; }
    #btn-close-prev:hover { color:var(--red); }

    /* â”€â”€ FORMAT FILTER BAR â”€â”€ */
    #filter-bar { display:none; flex-shrink:0; padding:6px 10px; border-bottom:1px solid var(--border); background:var(--panel); overflow-x:auto; scrollbar-width:none; gap:5px; flex-wrap:wrap; align-items:center; }
    #filter-bar::-webkit-scrollbar { display:none; }
    #filter-bar.visible { display:flex; }
    .filter-label { font-family:'Fira Code',monospace; font-size:.63rem; color:var(--muted); margin-right:4px; white-space:nowrap; }
    .fmt-chip { font-family:'Fira Code',monospace; font-size:.63rem; border:1px solid var(--border2); color:var(--muted); padding:2px 9px; border-radius:10px; cursor:pointer; transition:all .15s; white-space:nowrap; background:transparent; user-select:none; }
    .fmt-chip:hover  { border-color:var(--white); color:var(--white); }
    .fmt-chip.active { border-color:var(--red); color:var(--red); background:var(--red-dim); }
    .fmt-chip.all    { border-color:var(--muted); }

    /* â”€â”€ MODAL â”€â”€ */
    #modal-ov { position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:9000; display:none; align-items:center; justify-content:center; padding:20px; }
    #modal-ov.on { display:flex; }
    .mbox { background:var(--panel); border:1px solid var(--red); padding:24px; border-radius:6px; max-width:420px; width:100%; display:flex; flex-direction:column; gap:12px; box-shadow:0 8px 32px rgba(0,0,0,.25); }
    .mbox h3 { font-size:1rem; font-weight:700; color:var(--white); }
    .mbox p  { color:var(--muted); font-size:.82rem; line-height:1.65; }
    .mlist { max-height:120px; overflow-y:auto; background:var(--bg); border:1px solid var(--border); padding:8px 12px; font-family:'Fira Code',monospace; font-size:.65rem; color:var(--red); scrollbar-width:thin; border-radius:3px; }
    .mlist div { margin-bottom:3px; word-break:break-all; }
    .minput { background:var(--bg); border:1px solid var(--border2); color:var(--white); padding:8px 11px; font-family:'Fira Code',monospace; font-size:.85rem; border-radius:4px; width:100%; outline:none; transition:border-color .2s; }
    .minput:focus { border-color:var(--red); }
    .mactions { display:flex; gap:9px; justify-content:flex-end; }
    .btn-cancel  { background:transparent; border:1px solid var(--border2); color:var(--muted); padding:7px 16px; border-radius:4px; font-family:'Fira Code',monospace; font-size:.78rem; cursor:pointer; transition:all .2s; }
    .btn-cancel:hover  { border-color:var(--muted); color:var(--white); }
    .btn-confirm { background:var(--red); border:1px solid var(--red); color:#fff; padding:7px 16px; border-radius:4px; font-family:'Fira Code',monospace; font-size:.78rem; cursor:pointer; transition:all .2s; }
    .btn-confirm:hover { opacity:.85; }
    .btn-confirm:disabled { opacity:.3; cursor:not-allowed; }

    /* â”€â”€ LANGUAGE â”€â”€ */
    body.es .en { display:none !important; }
    body.en .es { display:none !important; }

    /* â”€â”€ OK SCREEN â”€â”€ */
    .ok-screen { height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:40px; text-align:center; }
    .ok-screen h2 { font-size:1.3rem; font-weight:700; }
    .ok-screen p  { color:var(--muted); font-size:.84rem; line-height:1.7; max-width:300px; }

    #mobile-input { display:none; }
  </style>
</head>
<body class="es">

<input type="file" id="mobile-input" webkitdirectory multiple>

<!-- NAV -->
<nav>
  <div style="display:flex;align-items:baseline;gap:10px;">
    <div class="logo">dupe<span>cleaner</span></div>
    <div style="font-family:'GoogleSans',sans-serif;font-weight:400;font-size:.67rem;color:var(--muted);">by jaimefg1888</div>
  </div>
  <div class="nav-right">

    <!-- Language -->
    <button class="lang-switch" id="lang-btn" onclick="toggleLang()">
      <i class="fas fa-globe"></i><span class="es">ESP</span><span class="en">ENG</span>
    </button>

    <!-- Light / Dark toggle -->
    <button class="icon-btn" id="theme-btn" onclick="toggleTheme()" title="Cambiar tema / Toggle theme">
      <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <div class="nav-folder" id="nav-folder" style="display:none;">
      <i class="fas fa-folder"></i><span id="nav-folder-name"></span>
    </div>
    <button class="nbtn" id="btn-stop" onclick="stopScan()">
      <i class="fas fa-stop"></i> <span class="es">Detener</span><span class="en">Stop</span>
    </button>
    <button class="nbtn" id="btn-reset" onclick="resetApp()">
      <i class="fas fa-rotate-left"></i> <span class="es">Nuevo escaneo</span><span class="en">New scan</span>
    </button>
    <div style="font-family:'Fira Code',monospace;font-size:.62rem;color:var(--dim);" class="es">SHA-256</div>
    <div style="font-family:'Fira Code',monospace;font-size:.62rem;color:var(--dim);" class="en">SHA-256</div>
  </div>
</nav>

<div class="app-body">
  <div id="pbar-wrap"><div id="pbar"></div></div>
  <div class="panels-row">

    <!-- LEFT: FEED -->
    <div class="panel" id="panel-left">
      <div class="ph">
        <div class="ph-l">
          <div class="dot d-idle" id="scan-dot"></div>
          <span id="scan-lbl"><span class="es">inactivo</span><span class="en">idle</span></span>
        </div>
        <span id="scan-cnt" style="font-family:'Fira Code',monospace;font-size:.66rem;color:var(--muted);font-weight:400;"></span>
      </div>
      <div id="feed">
        <div id="feed-ph" style="height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--dim);font-size:.75rem;text-align:center;pointer-events:none;font-family:'Fira Code',monospace;">
          <i class="fas fa-terminal" style="font-size:1.8rem;"></i>
          <span class="es">El registro aparecerÃ¡<br>aquÃ­ durante el escaneo</span>
          <span class="en">The log will appear<br>here during the scan</span>
        </div>
      </div>
    </div>

    <div class="divider" id="div-1"></div>

    <!-- MID: DUPLICATES -->
    <div class="panel" id="panel-mid">
      <div class="ph">
        <div class="ph-l">
          <span class="es">conjuntos de duplicados</span>
          <span class="en">duplicate sets</span>
          <span class="ph-sub es">(archivos con contenido idÃ©ntico)</span>
          <span class="ph-sub en">(files with identical content)</span>
        </div>
        <span class="badge z" id="dupe-badge">0</span>
      </div>

      <div id="filter-bar">
        <span class="filter-label es">formato:</span>
        <span class="filter-label en">format:</span>
        <button class="fmt-chip all active" data-ext="all" onclick="setFilter('all',this)">
          <span class="es">todos</span><span class="en">all</span>
        </button>
      </div>

      <div id="dupes-scroll">
        <div id="home">
          <div class="home-icon"><i class="fas fa-copy"></i></div>
          <h2>DupeCleaner</h2>
          <p class="es">Selecciona una carpeta â€” Descargas, Documentos, donde quieras. La app la escanea con SHA-256 y te muestra los archivos con contenido exactamente idÃ©ntico.</p>
          <p class="en">Select any folder â€” Downloads, Documents, wherever. The app scans it with SHA-256 and shows files with exactly identical content.</p>
          <button class="btn-primary" onclick="pickFolder()">
            <i class="fas fa-folder-open"></i>
            <span class="es">Seleccionar carpeta</span><span class="en">Select folder</span>
          </button>
          <p class="home-note" id="compat-note"></p>
          <div id="limited-warn" style="display:none;" class="home-warn">
            <span class="es"><i class="fas fa-circle-info"></i> Tu navegador no permite eliminar archivos desde la web.<br>El escaneo funciona con total normalidad, pero para borrar duplicados necesitas <strong>Chrome o Edge</strong> (escritorio o Android).</span>
            <span class="en"><i class="fas fa-circle-info"></i> Your browser doesn't allow deleting files from the web.<br>Scanning works fine, but to delete duplicates you need <strong>Chrome or Edge</strong> (desktop or Android).</span>
          </div>
        </div>
        <div id="confirm-step">
          <div class="home-icon" style="font-size:2rem;"><i class="fas fa-folder-open"></i></div>
          <h3><span class="es">Carpeta seleccionada</span><span class="en">Folder selected</span></h3>
          <div class="confirm-path" id="confirm-path-text"></div>
          <p class="es">Se escanearÃ¡n todos los archivos de esta carpeta y sus subcarpetas. Solo se omiten las carpetas crÃ­ticas del sistema operativo Windows.</p>
          <p class="en">All files in this folder and subfolders will be scanned. Only critical Windows OS folders are skipped.</p>
          <div class="confirm-btns">
            <button class="btn-secondary" onclick="cancelPick()"><i class="fas fa-xmark"></i> <span class="es">Cancelar</span><span class="en">Cancel</span></button>
            <button class="btn-primary"   onclick="beginScan()"><i class="fas fa-magnifying-glass"></i> <span class="es">Iniciar escaneo</span><span class="en">Start scan</span></button>
          </div>
        </div>
      </div>

      <!-- STATS BAR -->
      <div id="stats-bar">
        <div class="sbar-left">
          <span class="es">escaneados:</span><span class="en">scanned:</span>
          &nbsp;<span class="sbar-val" id="st-files">0</span>
          <span class="sbar-sep">Â·</span>
          <span class="es">recuperable:</span><span class="en">recoverable:</span>
          &nbsp;<span class="sbar-val" id="st-size">â€”</span>
        </div>
        <div class="sbar-center"><span id="sel-info"></span></div>
        <div class="sbar-right">
          <button class="sbar-btn" onclick="selectAll()">
            <i class="fas fa-check-double"></i> <span class="es">Sel. todos</span><span class="en">Select all</span>
          </button>
          <button class="sbar-btn" onclick="deselectAll()">
            <i class="fas fa-xmark"></i> <span class="es">Desel. todos</span><span class="en">Deselect all</span>
          </button>
          <button id="btn-del" onclick="openModal()">
            <i class="fas fa-trash-alt"></i>
            <span class="es">Eliminar</span><span class="en">Delete</span>
            (<span id="sel-cnt">0</span>)
          </button>
        </div>
      </div>
    </div>

    <div class="divider" id="div-2"></div>

    <!-- RIGHT: PREVIEW -->
    <div class="panel" id="panel-right">
      <div class="ph">
        <div class="ph-l">
          <i class="fas fa-eye" style="font-size:.78rem;color:var(--red);"></i>
          <span><span class="es">vista previa</span><span class="en">preview</span></span>
        </div>
        <div style="display:flex;align-items:center;gap:5px;min-width:0;">
          <span id="prev-lbl" style="font-family:'Fira Code',monospace;font-size:.63rem;color:var(--muted);font-weight:400;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:110px;"></span>
          <button id="btn-close-prev" onclick="closePreview()" style="display:none;" title="Cerrar / Close"><i class="fas fa-xmark"></i></button>
        </div>
      </div>
      <div id="prev-body">
        <div id="prev-empty">
          <i class="fas fa-hand-pointer"></i>
          <span style="font-family:'Fira Code',monospace;font-size:.73rem;">
            <span class="es">Pulsa el ojo<br>de cualquier archivo</span>
            <span class="en">Click the eye<br>on any file</span>
          </span>
        </div>
        <div id="prev-content"></div>
      </div>
    </div>

  </div>
</div>

<!-- DELETE MODAL -->
<div id="modal-ov">
  <div class="mbox">
    <h3><i class="fas fa-triangle-exclamation" style="color:var(--red);margin-right:7px;"></i>
      <span class="es">Eliminar permanentemente</span><span class="en">Permanently delete</span>
    </h3>
    <p class="es">Los archivos seleccionados se borrarÃ¡n del disco. <strong>Sin papelera. Sin deshacer.</strong></p>
    <p class="en">The selected files will be permanently removed from disk. <strong>No recycle bin. No undo.</strong></p>
    <div class="mlist" id="modal-list"></div>
    <p class="es">Escribe <strong style="color:var(--red)">CONFIRMAR</strong> para activar el botÃ³n:</p>
    <p class="en">Type <strong style="color:var(--red)">CONFIRM</strong> to enable the button:</p>
    <input class="minput" id="modal-input" placeholder="CONFIRMAR" oninput="checkConfirm(this.value)" autocomplete="off" spellcheck="false">
    <div class="mactions">
      <button class="btn-cancel"  onclick="closeModal()"><span class="es">Cancelar</span><span class="en">Cancel</span></button>
      <button class="btn-confirm" id="btn-confirm" disabled onclick="execDelete()">
        <i class="fas fa-trash-alt"></i> <span class="es">Eliminar</span><span class="en">Delete</span>
      </button>
    </div>
  </div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WINDOWS CRITICAL SYSTEM PATHS ONLY
//  Normal user folders (Downloads, Documents, Desktopâ€¦) are NEVER blocked
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BLOCKED = new Set([
  'windows','system32','syswow64','program files','program files (x86)',
  'programdata','system volume information','$recycle.bin','recovery',
  'boot','efi','winsxs','drivers','assembly','windowsapps','windowspowershell',
  'microsoft.net','servicing','installer','prefetch',
]);
function isBlocked(path) {
  return path.toLowerCase().replace(/\\/g,'/').split('/').some(p => BLOCKED.has(p));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dirHandle   = null;
let cancelled   = false;
let scanning    = false;
let limitedMode = false;   // true = no File System Access API â†’ scan only
let fileCount   = 0;
let skipCount   = 0;
let feedCount   = 0;
const MAX_FEED  = 300;

const FILES  = new Map();
const GROUPS = new Map();
const SEL    = new Set();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const t = (es, en) => document.body.classList.contains('es') ? es : en;

const fmtSize = b =>
  b < 1024         ? b + ' B'
  : b < 1048576    ? (b/1024).toFixed(1)      + ' KB'
  : b < 1073741824 ? (b/1048576).toFixed(2)   + ' MB'
  :                  (b/1073741824).toFixed(2) + ' GB';

const ICONS = {
  jpg:'fa-file-image',jpeg:'fa-file-image',png:'fa-file-image',gif:'fa-file-image',
  webp:'fa-file-image',bmp:'fa-file-image',heic:'fa-file-image',svg:'fa-file-image',
  pdf:'fa-file-pdf',
  mp4:'fa-file-video',mkv:'fa-file-video',avi:'fa-file-video',mov:'fa-file-video',
  mp3:'fa-file-audio',wav:'fa-file-audio',flac:'fa-file-audio',ogg:'fa-file-audio',
  zip:'fa-file-zipper',rar:'fa-file-zipper','7z':'fa-file-zipper',gz:'fa-file-zipper',
  doc:'fa-file-word',docx:'fa-file-word',xls:'fa-file-excel',xlsx:'fa-file-excel',
  js:'fa-file-code',ts:'fa-file-code',py:'fa-file-code',
  html:'fa-file-code',css:'fa-file-code',json:'fa-file-code',
  txt:'fa-file-lines',md:'fa-file-lines',csv:'fa-file-lines',log:'fa-file-lines',
};
const getIcon = n => 'fas ' + (ICONS[n.split('.').pop().toLowerCase()] || 'fa-file');
const isImg   = n => /\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(n);
const isTxt   = n => /\.(txt|md|json|js|ts|py|html|css|log|csv|xml|sh|bat|c|cpp|h|java|rb|php)$/i.test(n);
const frame   = () => new Promise(r => requestAnimationFrame(r));
const hasFSAPI = () => 'showDirectoryPicker' in window;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME  (light default)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme() {
  const dark = document.body.classList.toggle('dark');
  document.getElementById('theme-icon').className = dark ? 'fas fa-sun' : 'fas fa-moon';
  try { localStorage.setItem('dc-theme', dark ? 'dark' : 'light'); } catch {}
}
// restore saved theme
(function() {
  try {
    if (localStorage.getItem('dc-theme') === 'dark') {
      document.body.classList.add('dark');
      document.getElementById('theme-icon').className = 'fas fa-sun';
    }
  } catch {}
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleLang() {
  const isEs = document.body.classList.contains('es');
  document.body.classList.toggle('es', !isEs);
  document.body.classList.toggle('en',  isEs);
  document.documentElement.lang = isEs ? 'en' : 'es';
  document.getElementById('modal-input').placeholder = isEs ? 'CONFIRM' : 'CONFIRMAR';
  updateCompatNote();
  updateSelectionUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPAT NOTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCompatNote() {
  const el = document.getElementById('compat-note');
  if (!el) return;
  if (hasFSAPI()) {
    el.textContent = t(
      'Chrome Â· Edge Â· Android Chrome â€” escaneo y eliminaciÃ³n completos',
      'Chrome Â· Edge Â· Android Chrome â€” full scan and deletion'
    );
  } else {
    el.textContent = t(
      'Firefox / Safari â€” solo escaneo (sin eliminaciÃ³n)',
      'Firefox / Safari â€” scan only (deletion not supported)'
    );
  }
}
updateCompatNote();

// show limited warning if no FS API
if (!hasFSAPI()) {
  document.getElementById('limited-warn').style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER â€” multi-select, reads data-ext on .dg
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const activeFilters = new Set();
const detectedExts  = new Set();

function addExtToFilter(ext) {
  ext = ext.toLowerCase();
  if (detectedExts.has(ext)) return;
  detectedExts.add(ext);
  const bar  = document.getElementById('filter-bar');
  bar.classList.add('visible');
  const chip = document.createElement('button');
  chip.className = 'fmt-chip'; chip.dataset.ext = ext; chip.textContent = '.' + ext;
  chip.onclick = () => setFilter(ext, chip);
  bar.appendChild(chip);
}

function setFilter(ext, el) {
  if (ext === 'all') {
    activeFilters.clear();
    document.querySelectorAll('.fmt-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
  } else {
    activeFilters.has(ext) ? activeFilters.delete(ext) : activeFilters.add(ext);
    el.classList.toggle('active', activeFilters.has(ext));
    document.querySelector('.fmt-chip.all')?.classList.toggle('active', activeFilters.size === 0);
  }
  applyFilter();
}

function applyFilter() {
  document.querySelectorAll('.dg').forEach(grp => {
    grp.style.display = (activeFilters.size === 0 || activeFilters.has(grp.dataset.ext)) ? '' : 'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZABLE PANELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeDivider(divId, leftId, rightId) {
  const div = document.getElementById(divId);
  const L   = document.getElementById(leftId);
  const R   = document.getElementById(rightId);
  div.addEventListener('mousedown', e => {
    e.preventDefault();
    const x0=e.clientX, w0L=L.getBoundingClientRect().width, w0R=R.getBoundingClientRect().width;
    div.classList.add('drag');
    const mv = ev => {
      L.style.cssText += `;flex:none;width:${Math.max(100,w0L+ev.clientX-x0)}px`;
      R.style.cssText += `;flex:none;width:${Math.max(100,w0R-(ev.clientX-x0))}px`;
    };
    const up = () => { div.classList.remove('drag'); document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',up); };
    document.addEventListener('mousemove',mv);
    document.addEventListener('mouseup',up);
  });
}
makeDivider('div-1','panel-left','panel-mid');
makeDivider('div-2','panel-mid', 'panel-right');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $feed = document.getElementById('feed');
function feedLine(text, cls) {
  document.getElementById('feed-ph')?.remove();
  const el = document.createElement('div');
  el.className = 'fl fl-' + cls; el.textContent = text;
  $feed.appendChild(el); feedCount++;
  if (feedCount > MAX_FEED) { $feed.querySelector('.fl')?.remove(); feedCount--; }
  $feed.scrollTop = $feed.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHA-256
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sha256(fi) {
  try {
    const file = fi.fileObj ? fi.fileObj : await fi.handle.getFile();
    const hash = await crypto.subtle.digest('SHA-256', await file.arrayBuffer());
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
  } catch { return null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PICK FOLDER
//  Strategy: ALWAYS try File System Access API first (works on Chrome/Edge
//  desktop AND Android). Fall back to <input webkitdirectory> only when the
//  API is unavailable (Firefox, Safari, old browsers).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pickFolder() {
  if (hasFSAPI()) {
    // â”€â”€ Full mode: File System Access API â”€â”€
    limitedMode = false;
    try { dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' }); }
    catch { return; }  // user cancelled
    try {
      const p = await dirHandle.requestPermission({ mode: 'readwrite' });
      if (p !== 'granted') {
        alert(t(
          'Se necesita permiso de acceso. Acepta el permiso del navegador.',
          'Access permission required. Accept the browser permission prompt.'
        ));
        return;
      }
    } catch {}  // already has permission
    showConfirm(dirHandle.name);

  } else {
    // â”€â”€ Compatible mode: <input webkitdirectory> â”€â”€
    limitedMode = true;
    document.getElementById('mobile-input').click();
  }
}

document.getElementById('mobile-input').addEventListener('change', function() {
  const files = Array.from(this.files);
  if (!files.length) return;
  const rootName = files[0].webkitRelativePath.split('/')[0];
  dirHandle = { name: rootName, _inputFiles: files };
  showConfirm(rootName);
});

function showConfirm(name) {
  document.getElementById('home').style.display         = 'none';
  document.getElementById('confirm-step').style.display = 'flex';
  document.getElementById('confirm-path-text').textContent = name;
}

function cancelPick() {
  dirHandle = null;
  document.getElementById('confirm-step').style.display = 'none';
  document.getElementById('home').style.display         = 'flex';
  document.getElementById('mobile-input').value         = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BEGIN SCAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function beginScan() {
  if (!dirHandle) return;
  FILES.clear(); GROUPS.clear(); SEL.clear();
  fileCount = 0; skipCount = 0; cancelled = false; scanning = true; feedCount = 0;
  activeFilters.clear(); detectedExts.clear();

  document.getElementById('confirm-step').style.display = 'none';
  document.getElementById('dupes-scroll').innerHTML     = '';

  const fb = document.getElementById('filter-bar');
  fb.classList.remove('visible');
  fb.querySelectorAll('.fmt-chip:not(.all)').forEach(c => c.remove());
  fb.querySelector('.fmt-chip.all').classList.add('active');
  $feed.innerHTML = ''; feedCount = 0;

  document.getElementById('nav-folder').style.display     = 'flex';
  document.getElementById('nav-folder-name').textContent  = dirHandle.name;
  document.getElementById('btn-stop').style.display       = 'block';
  document.getElementById('btn-reset').style.display      = 'none';
  document.getElementById('pbar').style.width             = '0%';
  document.getElementById('dupe-badge').textContent       = '0';
  document.getElementById('dupe-badge').classList.add('z');
  document.getElementById('btn-del').style.display        = 'none';
  document.getElementById('prev-empty').style.display     = 'flex';
  document.getElementById('prev-content').style.display   = 'none';
  document.getElementById('btn-close-prev').style.display = 'none';
  document.getElementById('prev-lbl').textContent         = '';
  updateStats(); updateSelectionUI();

  setDot('run', t('recopilando archivosâ€¦','collecting filesâ€¦'));
  await frame();
  feedLine('ğŸ“‚  ' + dirHandle.name, 'dir');
  await frame();

  if (limitedMode) {
    await collectFromInput(dirHandle._inputFiles);
  } else {
    await collect(dirHandle, dirHandle.name);
  }
  if (cancelled) { finishStopped(); return; }

  setDot('run', t('calculando SHA-256â€¦','computing SHA-256â€¦'));
  await frame();
  await findDupes();
  if (cancelled) { finishStopped(); return; }

  scanning = false;
  setDot('idle', t('completado','done'));
  document.getElementById('pbar').style.width        = '100%';
  document.getElementById('btn-stop').style.display  = 'none';
  document.getElementById('btn-reset').style.display = 'block';

  const gs = [...GROUPS.values()].filter(g => g.length > 1);
  feedLine('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'info');
  feedLine(
    'âœ“  ' + fileCount + ' ' + t('archivos escaneados','files scanned') + ' Â· ' +
    gs.length + ' ' + t('conjuntos de duplicados','duplicate sets') +
    (skipCount ? ' Â· ' + skipCount + ' ' + t('carpetas del sistema omitidas','system folders skipped') : ''),
    'ok'
  );

  if (gs.length === 0) {
    document.getElementById('dupes-scroll').innerHTML = `
      <div class="ok-screen">
        <div class="home-icon" style="font-size:2.5rem;opacity:.3;"><i class="fas fa-circle-check"></i></div>
        <h2 class="es">Â¡Sin duplicados!</h2><h2 class="en">No duplicates!</h2>
        <p class="es">No se encontraron archivos idÃ©nticos en <strong>${dirHandle.name}</strong>.</p>
        <p class="en">No identical files found in <strong>${dirHandle.name}</strong>.</p>
        <button class="btn-primary" onclick="resetApp()">
          <i class="fas fa-rotate-left"></i>
          <span class="es">Nuevo escaneo</span><span class="en">New scan</span>
        </button>
      </div>`;
  }
}

function finishStopped() {
  scanning = false; setDot('stop', t('detenido','stopped'));
  document.getElementById('btn-stop').style.display  = 'none';
  document.getElementById('btn-reset').style.display = 'block';
  feedLine(t('â€” Escaneo detenido por el usuario â€”','â€” Scan stopped by user â€”'), 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLLECT â€” File System Access API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function collect(dh, path) {
  for await (const [name, handle] of dh.entries()) {
    if (cancelled) return;
    const fullPath = path + '/' + name;
    if (handle.kind === 'directory') {
      if (isBlocked(fullPath)) {
        feedLine('âœ—  ' + name + '  [' + t('sistema','system') + ']', 'skip');
        skipCount++; await frame(); continue;
      }
      feedLine('â–¸  ' + fullPath, 'dir'); await frame();
      await collect(handle, fullPath);
    } else {
      feedLine('   ' + name, 'file');
      try {
        const file = await handle.getFile();
        FILES.set(fullPath, { handle, size:file.size, name, dir:path, hash:null, _sid:null, canDelete:true });
        fileCount++;
        document.getElementById('scan-cnt').textContent = fileCount + ' ' + t('archivos','files');
      } catch {}
      if (fileCount % 15 === 0) await frame();
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLLECT â€” <input webkitdirectory> fallback
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function collectFromInput(files) {
  const seenDirs = new Set();
  for (let i = 0; i < files.length; i++) {
    if (cancelled) return;
    const file  = files[i];
    const rel   = file.webkitRelativePath;
    const parts = rel.split('/');
    const name  = parts[parts.length - 1];
    const dir   = parts.slice(0, -1).join('/');
    if (!seenDirs.has(dir)) { seenDirs.add(dir); feedLine('â–¸  ' + dir, 'dir'); }
    feedLine('   ' + name, 'file');
    FILES.set(rel, { fileObj:file, handle:null, size:file.size, name, dir, hash:null, _sid:null, canDelete:false });
    fileCount++;
    document.getElementById('scan-cnt').textContent = fileCount + ' ' + t('archivos','files');
    if (fileCount % 30 === 0) await frame();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIND DUPLICATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function findDupes() {
  const bySize = new Map();
  for (const [key, fi] of FILES) {
    if (!bySize.has(fi.size)) bySize.set(fi.size, []);
    bySize.get(fi.size).push({ key, ...fi });
  }
  const candidates = [...bySize.values()].filter(g => g.length > 1);
  const total = candidates.reduce((s,g) => s+g.length, 0);
  if (total === 0) return;

  feedLine('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'info');
  feedLine('SHA-256: ' + total + ' ' + t('candidatos por tamaÃ±o','size-matched candidates'), 'info');
  await frame();

  let done = 0;
  const $pbar = document.getElementById('pbar');
  for (const group of candidates) {
    if (cancelled) return;
    for (const fi of group) {
      if (cancelled) return;
      feedLine('  âš¡ ' + fi.name, 'file');
      const hash = await sha256(fi);
      if (!hash) { done++; continue; }
      fi.hash = hash;
      if (FILES.has(fi.key)) FILES.get(fi.key).hash = hash;
      if (!GROUPS.has(hash)) GROUPS.set(hash, []);
      GROUPS.get(hash).push(fi);
      if (GROUPS.get(hash).length >= 2) {
        feedLine('ğŸ’¥ ' + t('DUPLICADO','DUPLICATE') + ': ' + fi.name, 'match');
        renderGroup(hash); await frame();
      }
      done++;
      $pbar.style.width = Math.round(done / total * 100) + '%';
      updateStats();
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER GROUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGroup(hash) {
  const files = GROUPS.get(hash);
  if (!files || files.length < 2) return;
  document.getElementById('grp-' + hash)?.remove();

  const ext = files[0].name.includes('.') ? files[0].name.split('.').pop().toLowerCase() : '';

  const el = document.createElement('div');
  el.className = 'dg'; el.id = 'grp-' + hash; el.dataset.ext = ext;

  el.innerHTML = `
    <div class="dg-hdr">
      <span>
        <span class="h">${hash.substring(0,14)}â€¦</span>
        &nbsp;Â·&nbsp;
        ${files.length} ${t('copias idÃ©nticas','identical copies')}
        &nbsp;Â·&nbsp;
        ${fmtSize(files[0].size)} ${t('c/u','each')}
        ${ext ? `&nbsp;Â·&nbsp; <span style="color:var(--muted)">.${ext}</span>` : ''}
      </span>
      <span class="sv" title="${t('espacio recuperable al borrar las copias','space freed by deleting copies')}">
        â†© ${fmtSize(files[0].size * (files.length - 1))}
      </span>
    </div>`;

  files.forEach((fi, i) => {
    const isOrig    = i === 0;
    const canDelete = !limitedMode && fi.canDelete !== false;
    let h = 5381;
    for (let j = 0; j < fi.key.length; j++) h = ((h<<5)+h) ^ fi.key.charCodeAt(j);
    const sid = 'r' + (h>>>0).toString(36);
    fi._sid = sid;
    if (FILES.has(fi.key)) FILES.get(fi.key)._sid = sid;

    const row     = document.createElement('div');
    row.className = 'df' + (isOrig ? ' orig' : '');
    row.id        = sid;
    const keyEsc  = fi.key.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const chkTitle = isOrig
      ? t('Original: no se puede eliminar','Original: cannot be deleted')
      : t('Solo lectura en este navegador','Read-only in this browser');
    const chkAttr = (isOrig || !canDelete) ? `disabled title="${chkTitle}"` : '';

    row.innerHTML = `
      <input type="checkbox" ${chkAttr} onchange="toggleSel('${keyEsc}',this.checked)">
      <i class="${getIcon(fi.name)} df-icon"></i>
      <div class="df-info">
        <div class="df-name">${fi.name}${isOrig ? `<span class="orig-tag">${t('original','original')}</span>` : ''}</div>
        <div class="df-path">${fi.dir}</div>
      </div>
      <button class="btn-eye" onclick="previewFile('${keyEsc}')" title="${t('Vista previa','Preview')}">
        <i class="fas fa-eye"></i>
      </button>`;
    el.appendChild(row);
  });

  document.getElementById('dupes-scroll').appendChild(el);
  addExtToFilter(ext);
  if (activeFilters.size > 0 && !activeFilters.has(ext)) el.style.display = 'none';
  updateStats();

  const n = [...GROUPS.values()].filter(g => g.length > 1).length;
  const badge = document.getElementById('dupe-badge');
  badge.textContent = n; badge.classList.toggle('z', n === 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSel(key, checked) {
  if (limitedMode) return;
  checked ? SEL.add(key) : SEL.delete(key);
  const fi = FILES.get(key);
  if (fi && fi._sid) document.getElementById(fi._sid)?.classList.toggle('sel', checked);
  updateSelectionUI();
}

function selectAll() {
  if (limitedMode) return;
  for (const [, files] of GROUPS) {
    if (files.length < 2) continue;
    files.forEach((fi, i) => {
      if (i === 0 || SEL.has(fi.key)) return;
      SEL.add(fi.key);
      if (fi._sid) {
        const row = document.getElementById(fi._sid);
        if (row) { row.classList.add('sel'); const cb = row.querySelector('input[type=checkbox]'); if(cb) cb.checked = true; }
      }
    });
  }
  updateSelectionUI();
}

function deselectAll() {
  for (const key of [...SEL]) {
    const fi = FILES.get(key);
    if (fi && fi._sid) {
      const row = document.getElementById(fi._sid);
      if (row) { row.classList.remove('sel'); const cb = row.querySelector('input[type=checkbox]'); if(cb) cb.checked = false; }
    }
  }
  SEL.clear();
  updateSelectionUI();
}

function getSelectedSize() {
  let total = 0;
  for (const key of SEL) { const fi = FILES.get(key); if (fi) total += fi.size; }
  return total;
}

function updateSelectionUI() {
  const n    = SEL.size;
  const size = getSelectedSize();

  document.getElementById('btn-del').style.display = (!limitedMode && n > 0) ? 'block' : 'none';
  document.getElementById('sel-cnt').textContent   = n;

  const infoEl = document.getElementById('sel-info');
  if (n === 0) {
    infoEl.style.display = 'none';
  } else {
    const label = n === 1
      ? t('1 archivo seleccionado', '1 file selected')
      : t(n + ' archivos seleccionados', n + ' files selected');
    infoEl.textContent   = 'â–¶ ' + label + ' Â· ' + fmtSize(size);
    infoEl.style.display = 'inline';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATISTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  document.getElementById('st-files').textContent = fileCount;
  const gs = [...GROUPS.values()].filter(g => g.length > 1);
  const w  = gs.reduce((s,g) => s + g[0].size * (g.length - 1), 0);
  document.getElementById('st-size').textContent = w > 0 ? fmtSize(w) : 'â€”';
  const badge = document.getElementById('dupe-badge');
  badge.textContent = gs.length; badge.classList.toggle('z', gs.length === 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function previewFile(key) {
  const fi = FILES.get(key); if (!fi) return;
  document.getElementById('prev-empty').style.display     = 'none';
  document.getElementById('btn-close-prev').style.display = 'block';
  const $c = document.getElementById('prev-content');
  $c.style.display = 'block';
  document.getElementById('prev-lbl').textContent = fi.name;

  $c.innerHTML = `
    <div style="margin-bottom:12px;">
      <div class="pv-name">${fi.name}</div>
      <div class="pv-meta">${fi.dir} &nbsp;Â·&nbsp; <span class="ac">${fmtSize(fi.size)}</span></div>
    </div>
    <div id="pv-loading" style="color:var(--dim);font-family:'Fira Code',monospace;font-size:.72rem;text-align:center;padding:20px;">
      ${t('Cargandoâ€¦','Loadingâ€¦')}
    </div>`;

  try {
    const file = fi.fileObj ? fi.fileObj : await fi.handle.getFile();
    document.getElementById('pv-loading')?.remove();

    if (isImg(fi.name)) {
      const url  = URL.createObjectURL(file);
      const wrap = document.createElement('div'); wrap.style.cssText = 'text-align:center;';
      const img  = document.createElement('img');
      img.style.cssText = 'max-width:100%;max-height:calc(100vh - 160px);border-radius:4px;border:1px solid var(--border);display:block;margin:0 auto;';
      img.src = url; img.alt = fi.name; img.onload = () => URL.revokeObjectURL(url);
      wrap.appendChild(img); $c.appendChild(wrap);

    } else if (isTxt(fi.name) && fi.size < 1048576) {
      const text = await file.text();
      const ext  = fi.name.includes('.') ? fi.name.split('.').pop().toLowerCase() : '';
      const pre  = document.createElement('pre');
      pre.style.cssText = `font-family:'Fira Code',monospace;font-size:.72rem;line-height:1.65;color:var(--white);background:var(--code-bg);padding:12px;border-radius:4px;border:1px solid var(--border);white-space:pre-wrap;word-break:break-all;max-height:calc(100vh - 160px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--red) transparent;`;
      pre.textContent = text.length > 12000 ? text.substring(0,12000) + '\nâ€¦ (' + t('truncado','truncated') + ')' : text;
      $c.appendChild(pre);
      const note = document.createElement('div');
      note.style.cssText = 'font-family:"Fira Code",monospace;font-size:.6rem;color:var(--muted);margin-top:5px;text-align:right;';
      note.textContent = (ext ? '.' + ext : t('sin extensiÃ³n','no ext')) + ' Â· ' + fmtSize(fi.size);
      $c.appendChild(note);

    } else if (fi.name.toLowerCase().endsWith('.pdf')) {
      const url = URL.createObjectURL(file);
      const embed = document.createElement('embed');
      embed.src = url; embed.type = 'application/pdf';
      embed.style.cssText = 'width:100%;height:calc(100vh - 160px);border:1px solid var(--border);border-radius:4px;';
      $c.appendChild(embed);

    } else {
      const ext = fi.name.includes('.') ? fi.name.split('.').pop().toUpperCase() : t('SIN EXT','NO EXT');
      const d   = document.createElement('div');
      d.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:14px;padding:28px 16px;text-align:center;';
      d.innerHTML = `
        <i class="${getIcon(fi.name)}" style="font-size:3.5rem;color:var(--dim);"></i>
        <div style="font-size:1rem;font-weight:700;color:var(--white);">.${ext.toLowerCase()}</div>
        <div style="font-size:1.35rem;font-weight:700;color:var(--red);">${fmtSize(fi.size)}</div>
        <div style="font-family:'Fira Code',monospace;font-size:.63rem;color:var(--muted);max-width:220px;line-height:1.7;">
          ${t(
            'Archivo binario â€” sin previsualizaciÃ³n.<br>Contenido byte a byte idÃ©ntico al del resto de copias (mismo SHA-256).',
            'Binary file â€” no preview available.<br>Content is byte-for-byte identical to all other copies (same SHA-256).'
          )}
        </div>`;
      $c.appendChild(d);
    }
  } catch(e) {
    document.getElementById('pv-loading')?.remove();
    $c.innerHTML += `<div style="color:var(--red);font-size:.72rem;font-family:'Fira Code',monospace;margin-top:8px;">${t('Error al cargar','Error loading')}: ${e.message}</div>`;
  }
}

function closePreview() {
  document.getElementById('prev-content').style.display   = 'none';
  document.getElementById('prev-empty').style.display     = 'flex';
  document.getElementById('btn-close-prev').style.display = 'none';
  document.getElementById('prev-lbl').textContent         = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS DOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setDot(state, label) {
  document.getElementById('scan-dot').className   = 'dot d-' + state;
  document.getElementById('scan-lbl').textContent = label;
}

function stopScan() { cancelled = true; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetApp() {
  cancelled = true; scanning = false; limitedMode = false;
  dirHandle = null; FILES.clear(); GROUPS.clear(); SEL.clear();
  fileCount = 0; skipCount = 0; feedCount = 0;
  activeFilters.clear(); detectedExts.clear();
  document.getElementById('mobile-input').value = '';

  const fb = document.getElementById('filter-bar');
  fb.classList.remove('visible');
  fb.querySelectorAll('.fmt-chip:not(.all)').forEach(c => c.remove());
  fb.querySelector('.fmt-chip.all')?.classList.add('active');

  const limitedWarnVisible = !hasFSAPI();
  document.getElementById('dupes-scroll').innerHTML = `
    <div id="home">
      <div class="home-icon"><i class="fas fa-copy"></i></div>
      <h2>DupeCleaner</h2>
      <p class="es">Selecciona una carpeta â€” Descargas, Documentos, donde quieras. La app la escanea con SHA-256 y te muestra los archivos con contenido exactamente idÃ©ntico.</p>
      <p class="en">Select any folder â€” Downloads, Documents, wherever. The app scans it with SHA-256 and shows files with exactly identical content.</p>
      <button class="btn-primary" onclick="pickFolder()">
        <i class="fas fa-folder-open"></i>
        <span class="es">Seleccionar carpeta</span><span class="en">Select folder</span>
      </button>
      <p class="home-note" id="compat-note"></p>
      <div id="limited-warn" style="${limitedWarnVisible ? 'display:block;' : 'display:none;'}" class="home-warn">
        <span class="es"><i class="fas fa-circle-info"></i> Tu navegador no permite eliminar archivos desde la web.<br>El escaneo funciona con total normalidad, pero para borrar duplicados necesitas <strong>Chrome o Edge</strong> (escritorio o Android).</span>
        <span class="en"><i class="fas fa-circle-info"></i> Your browser doesn't allow deleting files from the web.<br>Scanning works fine, but to delete duplicates you need <strong>Chrome or Edge</strong> (desktop or Android).</span>
      </div>
    </div>
    <div id="confirm-step" style="display:none;"></div>`;

  $feed.innerHTML = `
    <div id="feed-ph" style="height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--dim);font-size:.75rem;text-align:center;pointer-events:none;font-family:'Fira Code',monospace;">
      <i class="fas fa-terminal" style="font-size:1.8rem;"></i>
      <span class="es">El registro aparecerÃ¡<br>aquÃ­ durante el escaneo</span>
      <span class="en">The log will appear<br>here during the scan</span>
    </div>`;

  setDot('idle', t('inactivo','idle'));
  document.getElementById('scan-cnt').textContent          = '';
  document.getElementById('pbar').style.width              = '0%';
  document.getElementById('dupe-badge').textContent        = '0';
  document.getElementById('dupe-badge').classList.add('z');
  document.getElementById('btn-del').style.display         = 'none';
  document.getElementById('btn-stop').style.display        = 'none';
  document.getElementById('btn-reset').style.display       = 'none';
  document.getElementById('nav-folder').style.display      = 'none';
  document.getElementById('prev-empty').style.display      = 'flex';
  document.getElementById('prev-content').style.display    = 'none';
  document.getElementById('btn-close-prev').style.display  = 'none';
  document.getElementById('prev-lbl').textContent          = '';
  updateStats(); updateSelectionUI(); updateCompatNote();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal() {
  if (limitedMode) return;
  const list = document.getElementById('modal-list');
  list.innerHTML = '';
  for (const key of SEL) {
    const fi = FILES.get(key);
    if (fi) { const d = document.createElement('div'); d.textContent = fi.dir + '/' + fi.name; list.appendChild(d); }
  }
  document.getElementById('modal-input').value    = '';
  document.getElementById('btn-confirm').disabled = true;
  document.getElementById('modal-ov').classList.add('on');
}

function checkConfirm(v) {
  document.getElementById('btn-confirm').disabled = v !== t('CONFIRMAR','CONFIRM');
}

function closeModal() { document.getElementById('modal-ov').classList.remove('on'); }

async function execDelete() {
  if (limitedMode) return;
  closeModal();
  for (const key of [...SEL]) {
    const fi = FILES.get(key);
    if (!fi || !fi.handle) continue;
    try {
      await fi.handle.remove();
      feedLine('ğŸ—‘  ' + t('Eliminado','Deleted') + ': ' + fi.name, 'match');
      if (fi._sid) document.getElementById(fi._sid)?.remove();
      FILES.delete(key); SEL.delete(key);
    } catch(e) {
      feedLine('âœ—  ' + t('Error al eliminar','Delete error') + ': ' + fi.name + ' â€” ' + e.message, 'err');
    }
  }
  updateStats(); updateSelectionUI();
}
</script>
</body>
</html>
