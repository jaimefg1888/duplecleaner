<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DupeCleaner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @font-face { font-family:'GoogleSans'; src:url('GoogleSans-Regular.ttf') format('truetype'); font-weight:400; }
    @font-face { font-family:'GoogleSans'; src:url('GoogleSans-Bold.ttf')    format('truetype'); font-weight:700; }
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap');

    /* ── LIGHT (default) ── */
    :root {
      --bg:       #f5f5f5;
      --panel:    #ffffff;
      --border:   #e2e2e2;
      --border2:  #d0d0d0;
      --dim:      #c0c0c0;
      --muted:    #999;
      --white:    #1a1a1a;
      --red:      #e8002d;
      --red-dim:  rgba(232,0,45,0.07);
      --feed-bg:  #fafafa;
      --code-bg:  #f0f0f0;
      --shadow:   0 1px 4px rgba(0,0,0,.08);
    }
    /* ── DARK ── */
    body.dark {
      --bg:      #050505;
      --panel:   #0a0a0a;
      --border:  #1a1a1a;
      --border2: #2a2a2a;
      --dim:     #333;
      --muted:   #666;
      --white:   #f0f0f0;
      --red:     #ff0033;
      --red-dim: rgba(255,0,51,0.08);
      --feed-bg: #060606;
      --code-bg: #060606;
      --shadow:  none;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; overflow:hidden; background:var(--bg); color:var(--white); font-family:'GoogleSans',sans-serif; transition:background .25s,color .25s; }

    /* ── NAV ── */
    nav {
      height:52px; display:flex; align-items:center; justify-content:space-between;
      padding:0 22px; background:var(--panel); border-bottom:1px solid var(--border);
      box-shadow:var(--shadow); z-index:100; position:relative;
    }
    .logo { font-family:'Fira Code',monospace; font-size:1.25rem; font-weight:700; color:var(--white); }
    .logo span { color:var(--red); }
    .nav-right { display:flex; align-items:center; gap:8px; }
    .nav-folder {
      font-family:'Fira Code',monospace; font-size:.7rem; color:var(--muted);
      border:1px solid var(--border); padding:3px 10px; border-radius:4px;
      max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      background:var(--bg);
    }
    .nav-folder i { color:var(--red); margin-right:5px; }

    /* small nav buttons */
    .nbtn {
      background:transparent; border:1px solid var(--border2); color:var(--muted);
      /* TAREA 1: altura fija igual que icon-btn y lang-switch */
      height:32px; padding:0 12px; border-radius:4px; font-family:'Fira Code',monospace;
      font-size:.72rem; cursor:pointer; transition:all .2s; display:none; white-space:nowrap;
      align-items:center; gap:5px;
    }
    .nbtn:hover { border-color:var(--red); color:var(--red); background:var(--red-dim); }
    #btn-stop { border-color:var(--red); color:var(--red); }
    #btn-stop:hover { background:var(--red-dim); }

    /* TAREA 1: icon-btn altura fija 32px — simétrico con lang-switch */
    .icon-btn {
      background:transparent; border:1px solid var(--border2); color:var(--muted);
      width:32px; height:32px; border-radius:4px; font-size:.82rem; cursor:pointer;
      display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0;
    }
    .icon-btn:hover { border-color:var(--red); color:var(--red); background:var(--red-dim); }

    /* TAREA 1: lang-switch altura fija 32px — simétrico con icon-btn */
    .lang-switch {
      cursor:pointer; color:var(--muted); font-size:.75rem;
      display:flex; align-items:center; gap:5px; font-family:'Fira Code',monospace;
      border:1px solid var(--border2); height:32px; padding:0 10px; border-radius:4px;
      transition:.3s; background:transparent; white-space:nowrap; flex-shrink:0;
    }
    .lang-switch:hover { color:var(--red); border-color:var(--red); background:var(--red-dim); }

    /* ── PROGRESS ── */
    #pbar-wrap { height:2px; background:var(--border); flex-shrink:0; }
    #pbar { height:100%; background:var(--red); width:0%; transition:width .25s ease; box-shadow:0 0 8px var(--red); }

    /* ── LAYOUT ── */
    .app-body   { display:flex; flex-direction:column; height:calc(100vh - 54px); }
    .panels-row { flex:1; display:flex; overflow:hidden; }
    .panel      { display:flex; flex-direction:column; overflow:hidden; min-width:100px; }

    /* ── PANEL HEADER ── */
    .ph {
      height:36px; flex-shrink:0; display:flex; align-items:center; justify-content:space-between;
      padding:0 14px; background:var(--panel); border-bottom:1px solid var(--border);
      font-family:'GoogleSans',sans-serif; font-size:.82rem; font-weight:700; color:var(--white);
    }
    .ph-l { display:flex; align-items:center; gap:8px; overflow:hidden; }
    .ph-l span { white-space:nowrap; }
    .ph-sub { font-family:'Fira Code',monospace; font-size:.58rem; color:var(--muted); font-weight:400; white-space:nowrap; }
    .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
    .d-idle { background:var(--dim); }
    .d-run  { background:var(--red); animation:blink 1s infinite; }
    .d-stop { background:var(--muted); animation:none; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.15} }
    #scan-lbl { font-weight:700; }
    .badge { background:var(--red); color:#fff; border-radius:10px; padding:1px 8px; font-size:.67rem; font-family:'Fira Code',monospace; font-weight:700; flex-shrink:0; }
    .badge.z { background:var(--dim); color:var(--muted); }

    /* ── DIVIDERS ── */
    .divider { width:5px; flex-shrink:0; background:transparent; cursor:col-resize; position:relative; z-index:20; transition:background .15s; user-select:none; }
    .divider:hover,.divider.drag { background:var(--red); }
    .divider::after { content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:1px; height:40px; background:var(--border2); }

    /* ── LEFT PANEL ── */
    #panel-left { width:260px; border-right:1px solid var(--border); }
    #feed { flex:1; overflow:hidden; padding:8px 12px; font-family:'Fira Code',monospace; font-size:.67rem; line-height:1.8; background:var(--feed-bg); }
    .fl { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .fl-dir   { color:var(--white); opacity:.85; }
    .fl-file  { color:var(--muted); }
    .fl-skip  { color:var(--dim); font-style:italic; }
    .fl-match { color:var(--red); font-weight:700; }
    .fl-info  { color:var(--dim); }
    .fl-ok    { color:var(--white); font-weight:700; }
    .fl-err   { color:var(--red); }

    /* ── MID PANEL ── */
    #panel-mid { flex:1; border-right:1px solid var(--border); }
    #dupes-scroll { flex:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--red) transparent; }
    #dupes-scroll::-webkit-scrollbar { width:5px; }
    #dupes-scroll::-webkit-scrollbar-thumb { background:var(--red); border-radius:3px; }

    /* ── HOME ── */
    #home { height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:40px; text-align:center; }
    .home-icon { font-size:2.6rem; color:var(--red); opacity:.25; }
    #home h2 { font-size:1.35rem; font-weight:700; color:var(--white); }
    #home p  { color:var(--muted); font-size:.85rem; line-height:1.75; max-width:320px; }
    .home-note { font-family:'Fira Code',monospace; font-size:.65rem; color:var(--dim); }
    .home-warn {
      font-family:'Fira Code',monospace; font-size:.63rem; color:var(--red);
      border:1px solid rgba(232,0,45,.3); background:var(--red-dim);
      padding:7px 14px; border-radius:4px; max-width:340px; line-height:1.7;
    }

    /* ── CONFIRM ── */
    #confirm-step { display:none; height:100%; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:40px; text-align:center; }
    #confirm-step h3 { font-size:1.1rem; font-weight:700; }
    #confirm-step p  { color:var(--muted); font-size:.83rem; line-height:1.7; max-width:320px; }
    .confirm-path { font-family:'Fira Code',monospace; font-size:.78rem; color:var(--red); background:var(--red-dim); border:1px solid rgba(232,0,45,.25); padding:8px 16px; border-radius:4px; max-width:380px; word-break:break-all; }
    .confirm-btns { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }

    /* ── BUTTONS ── */
    .btn-primary   { display:inline-flex; align-items:center; gap:8px; padding:10px 20px; background:var(--red); border:1px solid var(--red); color:#fff; font-family:'Fira Code',monospace; font-size:.85rem; cursor:pointer; border-radius:4px; transition:all .2s; }
    .btn-primary:hover   { opacity:.88; transform:translateY(-1px); }
    .btn-secondary { display:inline-flex; align-items:center; gap:8px; padding:10px 20px; background:transparent; border:1px solid var(--border2); color:var(--muted); font-family:'Fira Code',monospace; font-size:.85rem; cursor:pointer; border-radius:4px; transition:all .2s; }
    .btn-secondary:hover { border-color:var(--white); color:var(--white); }

    /* ── DUPLICATE GROUPS ── */
    .dg { margin:8px 10px; border:1px solid var(--border); border-radius:4px; overflow:hidden; animation:si .25s ease; box-shadow:var(--shadow); }
    @keyframes si { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:none} }
    .dg-hdr { background:var(--red-dim); padding:6px 13px; border-bottom:1px solid var(--border); font-family:'Fira Code',monospace; font-size:.68rem; color:var(--muted); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .dg-hdr .h  { color:var(--red); }
    .dg-hdr .sv { color:var(--white); font-weight:700; white-space:nowrap; }
    .df { padding:8px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:9px; transition:background .1s; }
    .df:last-child { border-bottom:none; }
    .df:hover  { background:var(--red-dim); }
    .df.sel    { background:var(--red-dim); border-left:3px solid var(--red); }
    .df.orig   { border-left:3px solid var(--dim); }
    .df input[type=checkbox] { accent-color:var(--red); width:14px; height:14px; flex-shrink:0; cursor:pointer; }
    .df input[type=checkbox]:disabled { opacity:.25; }
    .df-icon   { font-size:.85rem; color:var(--dim); flex-shrink:0; }
    .df-info   { flex:1; min-width:0; }
    .df-name   { font-size:.83rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--white); }
    .df-path   { font-size:.63rem; color:var(--muted); font-family:'Fira Code',monospace; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .orig-tag  { font-size:.58rem; color:var(--red); border:1px solid var(--red); padding:0 4px; border-radius:2px; margin-left:6px; opacity:.6; vertical-align:middle; }
    .btn-eye   { background:transparent; border:1px solid var(--border); color:var(--dim); padding:3px 8px; border-radius:3px; font-size:.7rem; cursor:pointer; transition:all .18s; flex-shrink:0; }
    .btn-eye:hover { border-color:var(--red); color:var(--red); }

    /* ── STATS BAR ── */
    #stats-bar { min-height:40px; flex-shrink:0; display:flex; align-items:center; flex-wrap:wrap; gap:4px; padding:0 10px; border-top:1px solid var(--border); background:var(--panel); font-family:'Fira Code',monospace; font-size:.68rem; color:var(--muted); box-shadow:var(--shadow); }
    .sbar-left   { display:flex; align-items:center; gap:6px; }
    .sbar-center { flex:1; display:flex; align-items:center; justify-content:center; min-width:0; }
    .sbar-right  { display:flex; align-items:center; gap:5px; }
    .sbar-val    { color:var(--white); font-weight:700; }
    .sbar-sep    { color:var(--dim); }
    #sel-info    { display:none; font-family:'Fira Code',monospace; font-size:.68rem; color:var(--red); font-weight:700; }
    .sbar-btn { background:transparent; border:1px solid var(--border2); color:var(--muted); padding:3px 9px; border-radius:3px; font-family:'Fira Code',monospace; font-size:.64rem; cursor:pointer; transition:all .18s; white-space:nowrap; }
    .sbar-btn:hover { border-color:var(--white); color:var(--white); }
    #btn-del { background:var(--red); border:1px solid var(--red); color:#fff; padding:3px 10px; border-radius:3px; font-family:'Fira Code',monospace; font-size:.64rem; cursor:pointer; transition:all .18s; display:none; white-space:nowrap; }
    #btn-del:hover { opacity:.85; }

    /* ── RIGHT PANEL ── */
    #panel-right  { width:290px; }
    #prev-body    { flex:1; overflow:hidden; display:flex; flex-direction:column; }
    #prev-empty   { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; color:var(--dim); font-size:.8rem; text-align:center; }
    #prev-empty i { font-size:2.2rem; }
    #prev-content { flex:1; overflow-y:auto; padding:14px; display:none; scrollbar-width:thin; scrollbar-color:var(--border2) transparent; }
    #prev-content::-webkit-scrollbar       { width:4px; }
    #prev-content::-webkit-scrollbar-thumb { background:var(--border2); border-radius:2px; }
    .pv-name { font-size:.9rem; font-weight:700; word-break:break-all; margin-bottom:4px; color:var(--white); }
    .pv-meta { font-family:'Fira Code',monospace; font-size:.63rem; color:var(--muted); margin-bottom:12px; line-height:1.7; }
    .pv-meta .ac { color:var(--red); font-weight:700; }
    #btn-close-prev { background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:.78rem; padding:3px 5px; border-radius:3px; transition:color .15s; line-height:1; }
    #btn-close-prev:hover { color:var(--red); }

    /* ── FORMAT FILTER BAR ── */
    #filter-bar { display:none; flex-shrink:0; padding:6px 10px; border-bottom:1px solid var(--border); background:var(--panel); overflow-x:auto; scrollbar-width:none; gap:5px; flex-wrap:wrap; align-items:center; }
    #filter-bar::-webkit-scrollbar { display:none; }
    #filter-bar.visible { display:flex; }
    .filter-label { font-family:'Fira Code',monospace; font-size:.63rem; color:var(--muted); margin-right:4px; white-space:nowrap; }
    .fmt-chip { font-family:'Fira Code',monospace; font-size:.63rem; border:1px solid var(--border2); color:var(--muted); padding:2px 9px; border-radius:10px; cursor:pointer; transition:all .15s; white-space:nowrap; background:transparent; user-select:none; }
    .fmt-chip:hover  { border-color:var(--white); color:var(--white); }
    .fmt-chip.active { border-color:var(--red); color:var(--red); background:var(--red-dim); }
    .fmt-chip.all    { border-color:var(--muted); }

    /* ── MODAL (eliminar) ── */
    #modal-ov { position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:9000; display:none; align-items:center; justify-content:center; padding:20px; }
    #modal-ov.on { display:flex; }
    .mbox { background:var(--panel); border:1px solid var(--red); padding:24px; border-radius:6px; max-width:420px; width:100%; display:flex; flex-direction:column; gap:12px; box-shadow:0 8px 32px rgba(0,0,0,.25); }
    .mbox h3 { font-size:1rem; font-weight:700; color:var(--white); }
    .mbox p  { color:var(--muted); font-size:.82rem; line-height:1.65; }
    .mlist { max-height:120px; overflow-y:auto; background:var(--bg); border:1px solid var(--border); padding:8px 12px; font-family:'Fira Code',monospace; font-size:.65rem; color:var(--red); scrollbar-width:thin; border-radius:3px; }
    .mlist div { margin-bottom:3px; word-break:break-all; }
    .minput { background:var(--bg); border:1px solid var(--border2); color:var(--white); padding:8px 11px; font-family:'Fira Code',monospace; font-size:.85rem; border-radius:4px; width:100%; outline:none; transition:border-color .2s; }
    .minput:focus { border-color:var(--red); }
    .mactions { display:flex; gap:9px; justify-content:flex-end; }
    .btn-cancel  { background:transparent; border:1px solid var(--border2); color:var(--muted); padding:7px 16px; border-radius:4px; font-family:'Fira Code',monospace; font-size:.78rem; cursor:pointer; transition:all .2s; }
    .btn-cancel:hover  { border-color:var(--muted); color:var(--white); }
    .btn-confirm { background:var(--red); border:1px solid var(--red); color:#fff; padding:7px 16px; border-radius:4px; font-family:'Fira Code',monospace; font-size:.78rem; cursor:pointer; transition:all .2s; }
    .btn-confirm:hover { opacity:.85; }
    .btn-confirm:disabled { opacity:.3; cursor:not-allowed; }

    /* ── SETTINGS MODAL — TAREA 3 ── */
    #settings-ov { position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:9000; display:none; align-items:center; justify-content:center; padding:20px; }
    #settings-ov.on { display:flex; }
    .sbox {
      background:var(--panel); border:1px solid var(--border2); padding:24px;
      border-radius:6px; max-width:480px; width:100%; display:flex; flex-direction:column;
      gap:18px; box-shadow:0 8px 32px rgba(0,0,0,.35); max-height:90vh; overflow-y:auto;
    }
    .sbox h3 { font-size:1rem; font-weight:700; color:var(--white); display:flex; align-items:center; gap:8px; }
    .sfield { display:flex; flex-direction:column; gap:6px; }
    .sfield label { font-family:'Fira Code',monospace; font-size:.72rem; color:var(--muted); }
    .sfield textarea, .sfield input[type=number] {
      background:var(--bg); border:1px solid var(--border2); color:var(--white);
      padding:8px 11px; font-family:'Fira Code',monospace; font-size:.8rem;
      border-radius:4px; width:100%; outline:none; transition:border-color .2s; resize:vertical;
    }
    .sfield textarea { min-height:60px; }
    .sfield textarea:focus, .sfield input[type=number]:focus { border-color:var(--red); }
    .sfield .hint { font-family:'Fira Code',monospace; font-size:.62rem; color:var(--dim); line-height:1.6; }
    .ssize-row { display:flex; gap:8px; align-items:stretch; }
    .ssize-row input { flex:1; }
    .cfg-select {
      background:var(--bg); border:1px solid var(--border2); color:var(--muted);
      padding:8px 10px; font-family:'Fira Code',monospace; font-size:.8rem;
      border-radius:4px; outline:none; cursor:pointer; transition:border-color .2s;
    }
    .cfg-select:focus { border-color:var(--red); }

    /* ── LANGUAGE ── */
    body.es .en { display:none !important; }
    body.en .es { display:none !important; }

    /* ── OK SCREEN ── */
    .ok-screen { height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:40px; text-align:center; }
    .ok-screen h2 { font-size:1.3rem; font-weight:700; }
    .ok-screen p  { color:var(--muted); font-size:.84rem; line-height:1.7; max-width:300px; }

    #mobile-input { display:none; }

    /* ════════════════════════════════════════════════════
       TAREA 1 — RESPONSIVE / MOBILE  @media ≤ 768px
       ════════════════════════════════════════════════════ */
    /* El botón flotante de feed solo aparece en móvil */
    #mobile-feed-btn { display:none; }

    @media (max-width: 768px) {
      /* Permitir scroll vertical en móvil */
      html, body { overflow:auto; height:auto; }
      .app-body   { height:auto; min-height:calc(100svh - 54px); }

      /* Columnas → filas */
      .panels-row { flex-direction:column; overflow:visible; height:auto; flex:none; }

      /* Todos los paneles: ancho 100%, sin min-width */
      .panel { width:100% !important; flex:none !important; min-width:unset; overflow:visible; }

      /* Feed (izquierda): colapsado por defecto, expandible */
      #panel-left {
        height:0; overflow:hidden; border-right:none;
        border-bottom:1px solid var(--border);
        transition:height .3s ease;
        /* Cuando el feed tiene contenido vemos solo un extracto */
      }
      #panel-left.mobile-open { height:220px; }
      #panel-left.mobile-open #feed { overflow-y:auto; }

      /* Mid panel: prioridad absoluta — mínimo 60vh */
      #panel-mid { min-height:60svh; border-right:none; border-bottom:1px solid var(--border); }
      #dupes-scroll { max-height:60svh; overflow-y:auto; }

      /* Right panel (preview): debajo del mid */
      #panel-right { height:auto; border-right:none; border-top:1px solid var(--border); }
      #prev-empty  { min-height:80px; }
      #prev-content { max-height:50svh; }

      /* Ocultar divisores de redimensionado */
      .divider { display:none; }

      /* Nav comprimido */
      nav { padding:0 12px; gap:4px; }
      .logo { font-size:.95rem; }
      .nav-folder { display:none !important; }
      .nav-byline { display:none; }

      /* Stats bar: apilado */
      #stats-bar { flex-wrap:wrap; gap:6px; padding:8px 10px; min-height:auto; }
      .sbar-left   { flex:0 0 100%; justify-content:flex-start; }
      .sbar-center { flex:0 0 100%; }
      .sbar-right  { flex:0 0 100%; flex-wrap:wrap; gap:4px; }

      /* Home padding reducido */
      #home { padding:24px 20px; min-height:50svh; }

      /* Botón flotante de feed — solo en móvil */
      #mobile-feed-btn {
        display:flex !important;
        position:fixed; bottom:18px; right:18px; z-index:500;
        width:46px; height:46px; border-radius:50%;
        background:var(--red); border:none; color:#fff;
        font-size:1.05rem; cursor:pointer;
        align-items:center; justify-content:center;
        box-shadow:0 4px 20px rgba(232,0,45,.45);
        transition:transform .15s, opacity .15s;
      }
      #mobile-feed-btn:active { transform:scale(.9); }
      #mobile-feed-btn.feed-visible { background:var(--panel); color:var(--red); border:1px solid var(--red); }

      /* Settings box adaptado a móvil */
      .sbox { max-height:85svh; }
    }
  </style>
</head>
<body class="es">

<input type="file" id="mobile-input" webkitdirectory multiple>

<!-- TAREA 1: Botón flotante para mostrar/ocultar el feed en móvil -->
<button id="mobile-feed-btn" onclick="toggleMobileFeed()" title="Toggle log feed" aria-label="Toggle feed">
  <i class="fas fa-terminal"></i>
</button>

<!-- ── NAV ── -->
<nav>
  <div style="display:flex;align-items:baseline;gap:10px;">
    <div class="logo">dupe<span>cleaner</span></div>
    <div class="nav-byline" style="font-family:'GoogleSans',sans-serif;font-weight:400;font-size:.67rem;color:var(--muted);">by jaimefg1888</div>
  </div>
  <div class="nav-right">

    <!-- Language — TAREA 1: height:32px fijo -->
    <button class="lang-switch" id="lang-btn" onclick="toggleLang()">
      <i class="fas fa-globe"></i><span class="es">ESP</span><span class="en">ENG</span>
    </button>

    <!-- TAREA 3: Settings gear button — mismo height:32px que lang-switch -->
    <button class="icon-btn" id="settings-btn" onclick="openSettings()" title="Configuración / Settings">
      <i class="fas fa-gear"></i>
    </button>

    <!-- Theme — TAREA 1: height:32px fijo, perfectamente simétrico -->
    <button class="icon-btn" id="theme-btn" onclick="toggleTheme()" title="Cambiar tema / Toggle theme">
      <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <div class="nav-folder" id="nav-folder" style="display:none;">
      <i class="fas fa-folder"></i><span id="nav-folder-name"></span>
    </div>
    <button class="nbtn" id="btn-stop" onclick="stopScan()">
      <i class="fas fa-stop"></i> <span class="es">Detener</span><span class="en">Stop</span>
    </button>
    <button class="nbtn" id="btn-reset" onclick="resetApp()">
      <i class="fas fa-rotate-left"></i> <span class="es">Nuevo escaneo</span><span class="en">New scan</span>
    </button>
    <div style="font-family:'Fira Code',monospace;font-size:.62rem;color:var(--dim);" class="es">SHA-256</div>
    <div style="font-family:'Fira Code',monospace;font-size:.62rem;color:var(--dim);" class="en">SHA-256</div>
  </div>
</nav>

<div class="app-body">
  <div id="pbar-wrap"><div id="pbar"></div></div>
  <div class="panels-row">

    <!-- LEFT: FEED LOG -->
    <div class="panel" id="panel-left">
      <div class="ph">
        <div class="ph-l">
          <div class="dot d-idle" id="scan-dot"></div>
          <span id="scan-lbl"><span class="es">inactivo</span><span class="en">idle</span></span>
        </div>
        <span id="scan-cnt" style="font-family:'Fira Code',monospace;font-size:.66rem;color:var(--muted);font-weight:400;"></span>
      </div>
      <div id="feed">
        <div id="feed-ph" style="height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--dim);font-size:.75rem;text-align:center;pointer-events:none;font-family:'Fira Code',monospace;">
          <i class="fas fa-terminal" style="font-size:1.8rem;"></i>
          <span class="es">El registro aparecerá<br>aquí durante el escaneo</span>
          <span class="en">The log will appear<br>here during the scan</span>
        </div>
      </div>
    </div>

    <div class="divider" id="div-1"></div>

    <!-- MID: DUPLICATES — prioridad absoluta en móvil -->
    <div class="panel" id="panel-mid">
      <div class="ph">
        <div class="ph-l">
          <span class="es">conjuntos de duplicados</span>
          <span class="en">duplicate sets</span>
          <span class="ph-sub es">(archivos con contenido idéntico)</span>
          <span class="ph-sub en">(files with identical content)</span>
        </div>
        <span class="badge z" id="dupe-badge">0</span>
      </div>

      <div id="filter-bar">
        <span class="filter-label es">formato:</span>
        <span class="filter-label en">format:</span>
        <button class="fmt-chip all active" data-ext="all" onclick="setFilter('all',this)">
          <span class="es">todos</span><span class="en">all</span>
        </button>
      </div>

      <div id="dupes-scroll">
        <div id="home">
          <div class="home-icon"><i class="fas fa-copy"></i></div>
          <h2>DupeCleaner</h2>
          <p class="es">Selecciona una carpeta — Descargas, Documentos, donde quieras. La app la escanea con SHA-256 y te muestra los archivos con contenido exactamente idéntico.</p>
          <p class="en">Select any folder — Downloads, Documents, wherever. The app scans it with SHA-256 and shows files with exactly identical content.</p>
          <button class="btn-primary" onclick="pickFolder()">
            <i class="fas fa-folder-open"></i>
            <span class="es">Seleccionar carpeta</span><span class="en">Select folder</span>
          </button>
          <p class="home-note" id="compat-note"></p>
          <div id="limited-warn" style="display:none;" class="home-warn">
            <span class="es"><i class="fas fa-circle-info"></i> Tu navegador no permite eliminar archivos desde la web.<br>El escaneo funciona con total normalidad, pero para borrar duplicados necesitas <strong>Chrome o Edge</strong> (escritorio o Android).</span>
            <span class="en"><i class="fas fa-circle-info"></i> Your browser doesn't allow deleting files from the web.<br>Scanning works fine, but to delete duplicates you need <strong>Chrome or Edge</strong> (desktop or Android).</span>
          </div>
        </div>
        <div id="confirm-step">
          <div class="home-icon" style="font-size:2rem;"><i class="fas fa-folder-open"></i></div>
          <h3><span class="es">Carpeta seleccionada</span><span class="en">Folder selected</span></h3>
          <div class="confirm-path" id="confirm-path-text"></div>
          <p class="es">Se escanearán todos los archivos de esta carpeta y sus subcarpetas. Solo se omiten las carpetas críticas del sistema operativo (Windows, macOS y Linux).</p>
          <p class="en">All files in this folder and subfolders will be scanned. Only critical OS folders are skipped (Windows, macOS and Linux).</p>
          <div class="confirm-btns">
            <button class="btn-secondary" onclick="cancelPick()"><i class="fas fa-xmark"></i> <span class="es">Cancelar</span><span class="en">Cancel</span></button>
            <button class="btn-primary"   onclick="beginScan()"><i class="fas fa-magnifying-glass"></i> <span class="es">Iniciar escaneo</span><span class="en">Start scan</span></button>
          </div>
        </div>
      </div>

      <!-- STATS BAR -->
      <div id="stats-bar">
        <div class="sbar-left">
          <span class="es">escaneados:</span><span class="en">scanned:</span>
          &nbsp;<span class="sbar-val" id="st-files">0</span>
          <span class="sbar-sep">·</span>
          <span class="es">recuperable:</span><span class="en">recoverable:</span>
          &nbsp;<span class="sbar-val" id="st-size">—</span>
        </div>
        <div class="sbar-center"><span id="sel-info"></span></div>
        <div class="sbar-right">
          <button class="sbar-btn" onclick="selectAll()">
            <i class="fas fa-check-double"></i> <span class="es">Sel. todos</span><span class="en">Select all</span>
          </button>
          <button class="sbar-btn" onclick="deselectAll()">
            <i class="fas fa-xmark"></i> <span class="es">Desel. todos</span><span class="en">Deselect all</span>
          </button>
          <button id="btn-del" onclick="openModal()">
            <i class="fas fa-trash-alt"></i>
            <span class="es">Eliminar</span><span class="en">Delete</span>
            (<span id="sel-cnt">0</span>)
          </button>
        </div>
      </div>
    </div>

    <div class="divider" id="div-2"></div>

    <!-- RIGHT: PREVIEW -->
    <div class="panel" id="panel-right">
      <div class="ph">
        <div class="ph-l">
          <i class="fas fa-eye" style="font-size:.78rem;color:var(--red);"></i>
          <span><span class="es">vista previa</span><span class="en">preview</span></span>
        </div>
        <div style="display:flex;align-items:center;gap:5px;min-width:0;">
          <span id="prev-lbl" style="font-family:'Fira Code',monospace;font-size:.63rem;color:var(--muted);font-weight:400;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:110px;"></span>
          <button id="btn-close-prev" onclick="closePreview()" style="display:none;" title="Cerrar / Close"><i class="fas fa-xmark"></i></button>
        </div>
      </div>
      <div id="prev-body">
        <div id="prev-empty">
          <i class="fas fa-hand-pointer"></i>
          <span style="font-family:'Fira Code',monospace;font-size:.73rem;">
            <span class="es">Pulsa el ojo<br>de cualquier archivo</span>
            <span class="en">Click the eye<br>on any file</span>
          </span>
        </div>
        <div id="prev-content"></div>
      </div>
    </div>

  </div>
</div>

<!-- ── DELETE MODAL ── -->
<div id="modal-ov">
  <div class="mbox">
    <h3><i class="fas fa-triangle-exclamation" style="color:var(--red);margin-right:7px;"></i>
      <span class="es">Eliminar permanentemente</span><span class="en">Permanently delete</span>
    </h3>
    <p class="es">Los archivos seleccionados se borrarán del disco. <strong>Sin papelera. Sin deshacer.</strong></p>
    <p class="en">The selected files will be permanently removed from disk. <strong>No recycle bin. No undo.</strong></p>
    <div class="mlist" id="modal-list"></div>
    <p class="es">Escribe <strong style="color:var(--red)">CONFIRMAR</strong> para activar el botón:</p>
    <p class="en">Type <strong style="color:var(--red)">CONFIRM</strong> to enable the button:</p>
    <input class="minput" id="modal-input" placeholder="CONFIRMAR" oninput="checkConfirm(this.value)" autocomplete="off" spellcheck="false">
    <div class="mactions">
      <button class="btn-cancel"  onclick="closeModal()"><span class="es">Cancelar</span><span class="en">Cancel</span></button>
      <button class="btn-confirm" id="btn-confirm" disabled onclick="execDelete()">
        <i class="fas fa-trash-alt"></i> <span class="es">Eliminar</span><span class="en">Delete</span>
      </button>
    </div>
  </div>
</div>

<!-- ── SETTINGS MODAL — TAREA 3 ── -->
<div id="settings-ov">
  <div class="sbox">
    <h3>
      <i class="fas fa-gear" style="color:var(--red);"></i>
      <span class="es">Configuración del escaneo</span><span class="en">Scan settings</span>
    </h3>

    <!-- Carpetas a ignorar -->
    <div class="sfield">
      <label class="es">Carpetas a ignorar (separadas por comas):</label>
      <label class="en">Folders to ignore (comma-separated):</label>
      <textarea id="cfg-ignore" placeholder="node_modules, .git, .cache, dist, __pycache__"></textarea>
      <span class="hint es">Se añaden a las rutas del sistema bloqueadas por defecto (Windows, macOS, Linux).</span>
      <span class="hint en">Added on top of the system paths already blocked by default (Windows, macOS, Linux).</span>
    </div>

    <!-- Tamaño mínimo -->
    <div class="sfield">
      <label class="es">Tamaño mínimo de archivo a escanear:</label>
      <label class="en">Minimum file size to scan:</label>
      <div class="ssize-row">
        <input type="number" id="cfg-minsize" min="0" value="0" placeholder="0">
        <select id="cfg-minunit" class="cfg-select">
          <option value="1">B</option>
          <option value="1024" selected>KB</option>
          <option value="1048576">MB</option>
        </select>
      </div>
      <span class="hint es">Los archivos más pequeños que este umbral se omiten durante el escaneo.</span>
      <span class="hint en">Files smaller than this threshold are skipped during the scan.</span>
    </div>

    <!-- Estrategia de hash -->
    <div class="sfield">
      <label class="es">Estrategia de hash para archivos &gt; 20 MB:</label>
      <label class="en">Hash strategy for files &gt; 20 MB:</label>
      <select id="cfg-strategy" class="cfg-select" style="width:100%;">
        <option value="sample">
          <span class="es">Muestras (inicio + centro + final, 2 MB c/u) — ultrarrápido</span>
          <span class="en">Sampling (start + middle + end, 2 MB each) — ultra-fast</span>
        </option>
        <option value="full">
          <span class="es">Hash completo — lento pero exacto al 100%</span>
          <span class="en">Full hash — slow but 100% exact</span>
        </option>
      </select>
      <span class="hint es">El modo muestras evita Out-of-Memory en archivos gigantes y es suficiente en la mayoría de casos.</span>
      <span class="hint en">Sampling mode prevents Out-of-Memory on huge files and is sufficient for most use cases.</span>
    </div>

    <div class="mactions">
      <button class="btn-cancel" onclick="closeSettings()">
        <span class="es">Cancelar</span><span class="en">Cancel</span>
      </button>
      <button class="btn-confirm" onclick="saveSettings()" style="opacity:1;">
        <i class="fas fa-check"></i> <span class="es">Guardar</span><span class="en">Save</span>
      </button>
    </div>
  </div>
</div>

<script>
'use strict';

// ══════════════════════════════════════════════════════
//  TAREA 2 — WEB WORKER INLINE (Blob URL)
//  Mueve el cómputo SHA-256 off the main thread.
//  Para archivos > 20 MB usa estrategia de muestras
//  (slice de File API) para evitar OOM.
// ══════════════════════════════════════════════════════
const _WORKER_SRC = `
  self.onmessage = async function(e) {
    const { id, buffers } = e.data;
    try {
      let input;
      if (buffers.length === 1) {
        input = buffers[0];
      } else {
        // Concatenar las muestras en un único buffer antes de hashear
        const total  = buffers.reduce((s, b) => s + b.byteLength, 0);
        const merged = new Uint8Array(total);
        let   offset = 0;
        for (const buf of buffers) {
          merged.set(new Uint8Array(buf), offset);
          offset += buf.byteLength;
        }
        input = merged.buffer;
      }
      const raw  = await crypto.subtle.digest('SHA-256', input);
      const hash = Array.from(new Uint8Array(raw))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
      self.postMessage({ id, hash });
    } catch (err) {
      self.postMessage({ id, hash: null, error: err.message });
    }
  };
`;

const _workerBlob  = new Blob([_WORKER_SRC], { type: 'application/javascript' });
const _workerURL   = URL.createObjectURL(_workerBlob);
const _hashWorker  = new Worker(_workerURL);
let   _hashIdSeq   = 0;
const _hashPending = new Map();   // id → resolve

_hashWorker.onmessage = ({ data: { id, hash } }) => {
  const resolve = _hashPending.get(id);
  if (resolve) { _hashPending.delete(id); resolve(hash); }
};
_hashWorker.onerror = (err) => console.error('[HashWorker]', err);

// Umbrales de muestreo
const SAMPLE_THRESHOLD = 20 * 1024 * 1024;   // 20 MB → usar muestras
const SAMPLE_CHUNK     =  2 * 1024 * 1024;   // 2 MB por muestra (×3 = 6 MB máx. en RAM)

// ══════════════════════════════════════════════════════
//  TAREA 3 — RUTAS BLOQUEADAS: Windows + macOS + Linux
// ══════════════════════════════════════════════════════
const BLOCKED = new Set([
  // ── Windows ──
  'windows', 'system32', 'syswow64', 'program files', 'program files (x86)',
  'programdata', 'system volume information', '$recycle.bin', 'recovery',
  'boot', 'efi', 'winsxs', 'drivers', 'assembly', 'windowsapps',
  'windowspowershell', 'microsoft.net', 'servicing', 'installer', 'prefetch',
  // ── macOS ──
  'system', 'library', 'private', 'cores', 'developer',
  'volumes', '.trashes', '.spotlight-v100', '.fseventsd', 'macos',
  // ── Linux / Unix ──
  'bin', 'sbin', 'usr', 'etc', 'proc', 'dev', 'sys', 'run',
  'lib', 'lib64', 'lib32', 'libx32', 'srv', 'snap', 'lost+found',
]);

function isBlocked(path) {
  return path.toLowerCase().replace(/\\/g, '/').split('/').some(p => BLOCKED.has(p));
}

// ══════════════════════════════════════════════════════
//  TAREA 3 — CONFIGURACIÓN DE USUARIO
// ══════════════════════════════════════════════════════
let userIgnoreFolders = new Set();   // carpetas definidas por el usuario
let userMinFileSize   = 0;           // tamaño mínimo en bytes
let userHashStrategy  = 'sample';    // 'sample' | 'full'

function isUserIgnored(name) {
  return userIgnoreFolders.has(name.toLowerCase());
}

// ══════════════════════════════════════════════════════
//  ESTADO GLOBAL
// ══════════════════════════════════════════════════════
let dirHandle   = null;
let cancelled   = false;
let scanning    = false;
let limitedMode = false;
let fileCount   = 0;
let skipCount   = 0;
let feedCount   = 0;
const MAX_FEED  = 300;

const FILES  = new Map();
const GROUPS = new Map();
const SEL    = new Set();

// ══════════════════════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════════════════════
const t = (es, en) => document.body.classList.contains('es') ? es : en;

const fmtSize = b =>
  b < 1024         ? b + ' B'
  : b < 1048576    ? (b / 1024).toFixed(1)      + ' KB'
  : b < 1073741824 ? (b / 1048576).toFixed(2)   + ' MB'
  :                  (b / 1073741824).toFixed(2) + ' GB';

const ICONS = {
  jpg:'fa-file-image', jpeg:'fa-file-image', png:'fa-file-image', gif:'fa-file-image',
  webp:'fa-file-image', bmp:'fa-file-image', heic:'fa-file-image', svg:'fa-file-image',
  pdf:'fa-file-pdf',
  mp4:'fa-file-video', mkv:'fa-file-video', avi:'fa-file-video', mov:'fa-file-video', webm:'fa-file-video',
  mp3:'fa-file-audio', wav:'fa-file-audio', flac:'fa-file-audio', ogg:'fa-file-audio', aac:'fa-file-audio',
  zip:'fa-file-zipper', rar:'fa-file-zipper', '7z':'fa-file-zipper', gz:'fa-file-zipper',
  doc:'fa-file-word', docx:'fa-file-word', xls:'fa-file-excel', xlsx:'fa-file-excel',
  js:'fa-file-code', ts:'fa-file-code', py:'fa-file-code',
  html:'fa-file-code', css:'fa-file-code', json:'fa-file-code',
  txt:'fa-file-lines', md:'fa-file-lines', csv:'fa-file-lines', log:'fa-file-lines',
};
const getIcon = n  => 'fas ' + (ICONS[n.split('.').pop().toLowerCase()] || 'fa-file');
const isImg   = n  => /\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(n);
const isTxt   = n  => /\.(txt|md|json|js|ts|py|html|css|log|csv|xml|sh|bat|c|cpp|h|java|rb|php)$/i.test(n);
// TAREA 3: helpers para vídeo y audio
const isVideo = n  => /\.(mp4|webm|mkv|avi|mov|ogv|m4v)$/i.test(n);
const isAudio = n  => /\.(mp3|wav|flac|ogg|aac|m4a|opus|weba)$/i.test(n);
const frame   = () => new Promise(r => requestAnimationFrame(r));
const hasFSAPI = () => 'showDirectoryPicker' in window;

// ══════════════════════════════════════════════════════
//  TEMA
// ══════════════════════════════════════════════════════
function toggleTheme() {
  const dark = document.body.classList.toggle('dark');
  document.getElementById('theme-icon').className = dark ? 'fas fa-sun' : 'fas fa-moon';
  try { localStorage.setItem('dc-theme', dark ? 'dark' : 'light'); } catch {}
}
(function () {
  try {
    if (localStorage.getItem('dc-theme') === 'dark') {
      document.body.classList.add('dark');
      document.getElementById('theme-icon').className = 'fas fa-sun';
    }
  } catch {}
})();

// ══════════════════════════════════════════════════════
//  IDIOMA
// ══════════════════════════════════════════════════════
function toggleLang() {
  const isEs = document.body.classList.contains('es');
  document.body.classList.toggle('es', !isEs);
  document.body.classList.toggle('en', isEs);
  document.documentElement.lang = isEs ? 'en' : 'es';
  document.getElementById('modal-input').placeholder = isEs ? 'CONFIRM' : 'CONFIRMAR';
  updateCompatNote();
  updateSelectionUI();
}

// ══════════════════════════════════════════════════════
//  COMPAT NOTE
// ══════════════════════════════════════════════════════
function updateCompatNote() {
  const el = document.getElementById('compat-note');
  if (!el) return;
  el.textContent = hasFSAPI()
    ? t('Chrome · Edge · Android Chrome — escaneo y eliminación completos',
        'Chrome · Edge · Android Chrome — full scan and deletion')
    : t('Firefox / Safari — solo escaneo (sin eliminación)',
        'Firefox / Safari — scan only (deletion not supported)');
}
updateCompatNote();

if (!hasFSAPI()) {
  document.getElementById('limited-warn').style.display = 'block';
}

// ══════════════════════════════════════════════════════
//  TAREA 1 — TOGGLE FEED EN MÓVIL
// ══════════════════════════════════════════════════════
function toggleMobileFeed() {
  const panel = document.getElementById('panel-left');
  const btn   = document.getElementById('mobile-feed-btn');
  panel.classList.toggle('mobile-open');
  btn.classList.toggle('feed-visible', panel.classList.contains('mobile-open'));
}

// ══════════════════════════════════════════════════════
//  TAREA 3 — SETTINGS MODAL
// ══════════════════════════════════════════════════════
function openSettings() {
  document.getElementById('cfg-ignore').value  = [...userIgnoreFolders].join(', ');
  // Rellenar tamaño actual
  let displaySize = userMinFileSize;
  let unitVal = '1';
  if (userMinFileSize >= 1048576)      { displaySize = userMinFileSize / 1048576; unitVal = '1048576'; }
  else if (userMinFileSize >= 1024)    { displaySize = userMinFileSize / 1024;    unitVal = '1024'; }
  document.getElementById('cfg-minsize').value  = displaySize || 0;
  document.getElementById('cfg-minunit').value  = unitVal;
  document.getElementById('cfg-strategy').value = userHashStrategy;
  document.getElementById('settings-ov').classList.add('on');
}

function closeSettings() {
  document.getElementById('settings-ov').classList.remove('on');
}

function saveSettings() {
  // Parsear carpetas ignoradas
  const raw = document.getElementById('cfg-ignore').value;
  userIgnoreFolders = new Set(
    raw.split(',').map(s => s.trim().toLowerCase()).filter(Boolean)
  );
  // Parsear tamaño mínimo
  const sizeVal  = parseFloat(document.getElementById('cfg-minsize').value) || 0;
  const unitMult = parseInt(document.getElementById('cfg-minunit').value, 10) || 1;
  userMinFileSize = Math.max(0, Math.round(sizeVal * unitMult));
  // Estrategia de hash
  userHashStrategy = document.getElementById('cfg-strategy').value;
  closeSettings();
}

// Cerrar modales al hacer clic en el overlay
document.getElementById('settings-ov').addEventListener('click', e => { if (e.target === e.currentTarget) closeSettings(); });
document.getElementById('modal-ov').addEventListener('click',    e => { if (e.target === e.currentTarget) closeModal(); });

// ══════════════════════════════════════════════════════
//  FILTER
// ══════════════════════════════════════════════════════
const activeFilters = new Set();
const detectedExts  = new Set();

function addExtToFilter(ext) {
  ext = ext.toLowerCase();
  if (detectedExts.has(ext)) return;
  detectedExts.add(ext);
  const bar  = document.getElementById('filter-bar');
  bar.classList.add('visible');
  const chip = document.createElement('button');
  chip.className = 'fmt-chip'; chip.dataset.ext = ext; chip.textContent = '.' + ext;
  chip.onclick = () => setFilter(ext, chip);
  bar.appendChild(chip);
}

function setFilter(ext, el) {
  if (ext === 'all') {
    activeFilters.clear();
    document.querySelectorAll('.fmt-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
  } else {
    activeFilters.has(ext) ? activeFilters.delete(ext) : activeFilters.add(ext);
    el.classList.toggle('active', activeFilters.has(ext));
    document.querySelector('.fmt-chip.all')?.classList.toggle('active', activeFilters.size === 0);
  }
  applyFilter();
}

function applyFilter() {
  document.querySelectorAll('.dg').forEach(grp => {
    grp.style.display = (activeFilters.size === 0 || activeFilters.has(grp.dataset.ext)) ? '' : 'none';
  });
}

// ══════════════════════════════════════════════════════
//  RESIZABLE PANELS (escritorio)
// ══════════════════════════════════════════════════════
function makeDivider(divId, leftId, rightId) {
  const div = document.getElementById(divId);
  const L   = document.getElementById(leftId);
  const R   = document.getElementById(rightId);
  div.addEventListener('mousedown', e => {
    e.preventDefault();
    const x0 = e.clientX;
    const w0L = L.getBoundingClientRect().width;
    const w0R = R.getBoundingClientRect().width;
    div.classList.add('drag');
    const mv = ev => {
      L.style.cssText += `;flex:none;width:${Math.max(100, w0L + ev.clientX - x0)}px`;
      R.style.cssText += `;flex:none;width:${Math.max(100, w0R - (ev.clientX - x0))}px`;
    };
    const up = () => {
      div.classList.remove('drag');
      document.removeEventListener('mousemove', mv);
      document.removeEventListener('mouseup', up);
    };
    document.addEventListener('mousemove', mv);
    document.addEventListener('mouseup', up);
  });
}
makeDivider('div-1', 'panel-left', 'panel-mid');
makeDivider('div-2', 'panel-mid',  'panel-right');

// ══════════════════════════════════════════════════════
//  FEED
// ══════════════════════════════════════════════════════
const $feed = document.getElementById('feed');
function feedLine(text, cls) {
  document.getElementById('feed-ph')?.remove();
  const el = document.createElement('div');
  el.className = 'fl fl-' + cls;
  el.textContent = text;
  $feed.appendChild(el);
  feedCount++;
  if (feedCount > MAX_FEED) { $feed.querySelector('.fl')?.remove(); feedCount--; }
  $feed.scrollTop = $feed.scrollHeight;
}

// ══════════════════════════════════════════════════════
//  TAREA 2 — SHA-256 VÍA WEB WORKER + MUESTRAS
//
//  Lógica:
//  • Archivo ≤ 20 MB o estrategia 'full': leer buffer completo → Worker
//  • Archivo >  20 MB y estrategia 'sample':
//      Leer 3 fragmentos de 2 MB (inicio, centro, final) con File.slice()
//      → concatenar en Worker → SHA-256 del conjunto de muestras
//  Ventaja: máx. 6 MB en RAM independientemente del tamaño del archivo.
// ══════════════════════════════════════════════════════
async function sha256(fi) {
  return new Promise(async resolve => {
    try {
      const file = fi.fileObj ? fi.fileObj : await fi.handle.getFile();
      let buffers;

      if (file.size <= SAMPLE_THRESHOLD || userHashStrategy === 'full') {
        // Lectura completa — segura para ≤20 MB o cuando el usuario la fuerza
        buffers = [await file.arrayBuffer()];
      } else {
        // Estrategia de muestras: 3 slices × 2 MB = máx. 6 MB en RAM
        const mid = Math.max(0, Math.floor(file.size / 2) - SAMPLE_CHUNK / 2);
        const [s1, s2, s3] = await Promise.all([
          file.slice(0, SAMPLE_CHUNK).arrayBuffer(),
          file.slice(mid, mid + SAMPLE_CHUNK).arrayBuffer(),
          file.slice(Math.max(0, file.size - SAMPLE_CHUNK)).arrayBuffer(),
        ]);
        buffers = [s1, s2, s3];
      }

      const id = ++_hashIdSeq;
      _hashPending.set(id, resolve);
      // Transferencia de propiedad (zero-copy) para máximo rendimiento
      _hashWorker.postMessage({ id, buffers }, buffers);
    } catch {
      resolve(null);
    }
  });
}

// ══════════════════════════════════════════════════════
//  PICK FOLDER
// ══════════════════════════════════════════════════════
async function pickFolder() {
  if (hasFSAPI()) {
    limitedMode = false;
    try { dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' }); }
    catch { return; }
    try {
      const p = await dirHandle.requestPermission({ mode: 'readwrite' });
      if (p !== 'granted') {
        alert(t('Se necesita permiso de acceso. Acepta el permiso del navegador.',
                'Access permission required. Accept the browser permission prompt.'));
        return;
      }
    } catch {}
    showConfirm(dirHandle.name);
  } else {
    limitedMode = true;
    document.getElementById('mobile-input').click();
  }
}

document.getElementById('mobile-input').addEventListener('change', function () {
  const files = Array.from(this.files);
  if (!files.length) return;
  const rootName = files[0].webkitRelativePath.split('/')[0];
  dirHandle = { name: rootName, _inputFiles: files };
  showConfirm(rootName);
});

function showConfirm(name) {
  document.getElementById('home').style.display         = 'none';
  document.getElementById('confirm-step').style.display = 'flex';
  document.getElementById('confirm-path-text').textContent = name;
}

function cancelPick() {
  dirHandle = null;
  document.getElementById('confirm-step').style.display = 'none';
  document.getElementById('home').style.display         = 'flex';
  document.getElementById('mobile-input').value         = '';
}

// ══════════════════════════════════════════════════════
//  BEGIN SCAN
// ══════════════════════════════════════════════════════
async function beginScan() {
  if (!dirHandle) return;
  FILES.clear(); GROUPS.clear(); SEL.clear();
  fileCount = 0; skipCount = 0; cancelled = false; scanning = true; feedCount = 0;
  activeFilters.clear(); detectedExts.clear();

  document.getElementById('confirm-step').style.display = 'none';
  document.getElementById('dupes-scroll').innerHTML     = '';

  const fb = document.getElementById('filter-bar');
  fb.classList.remove('visible');
  fb.querySelectorAll('.fmt-chip:not(.all)').forEach(c => c.remove());
  fb.querySelector('.fmt-chip.all').classList.add('active');
  $feed.innerHTML = ''; feedCount = 0;

  document.getElementById('nav-folder').style.display     = 'flex';
  document.getElementById('nav-folder-name').textContent  = dirHandle.name;
  document.getElementById('btn-stop').style.display       = 'flex';
  document.getElementById('btn-reset').style.display      = 'none';
  document.getElementById('pbar').style.width             = '0%';
  document.getElementById('dupe-badge').textContent       = '0';
  document.getElementById('dupe-badge').classList.add('z');
  document.getElementById('btn-del').style.display        = 'none';
  document.getElementById('prev-empty').style.display     = 'flex';
  document.getElementById('prev-content').style.display   = 'none';
  document.getElementById('btn-close-prev').style.display = 'none';
  document.getElementById('prev-lbl').textContent         = '';
  updateStats(); updateSelectionUI();

  setDot('run', t('recopilando archivos…', 'collecting files…'));
  await frame();
  feedLine('📂  ' + dirHandle.name, 'dir');
  await frame();

  if (limitedMode) {
    await collectFromInput(dirHandle._inputFiles);
  } else {
    await collect(dirHandle, dirHandle.name);
  }
  if (cancelled) { finishStopped(); return; }

  setDot('run', t('calculando SHA-256…', 'computing SHA-256…'));
  await frame();
  await findDupes();
  if (cancelled) { finishStopped(); return; }

  scanning = false;
  setDot('idle', t('completado', 'done'));
  document.getElementById('pbar').style.width        = '100%';
  document.getElementById('btn-stop').style.display  = 'none';
  document.getElementById('btn-reset').style.display = 'flex';

  const gs = [...GROUPS.values()].filter(g => g.length > 1);
  feedLine('─────────────────────────────', 'info');
  feedLine(
    '✓  ' + fileCount + ' ' + t('archivos escaneados', 'files scanned') + ' · ' +
    gs.length + ' ' + t('conjuntos de duplicados', 'duplicate sets') +
    (skipCount ? ' · ' + skipCount + ' ' + t('carpetas omitidas', 'folders skipped') : ''),
    'ok'
  );

  if (gs.length === 0) {
    document.getElementById('dupes-scroll').innerHTML = `
      <div class="ok-screen">
        <div class="home-icon" style="font-size:2.5rem;opacity:.3;"><i class="fas fa-circle-check"></i></div>
        <h2 class="es">¡Sin duplicados!</h2><h2 class="en">No duplicates!</h2>
        <p class="es">No se encontraron archivos idénticos en <strong>${dirHandle.name}</strong>.</p>
        <p class="en">No identical files found in <strong>${dirHandle.name}</strong>.</p>
        <button class="btn-primary" onclick="resetApp()">
          <i class="fas fa-rotate-left"></i>
          <span class="es">Nuevo escaneo</span><span class="en">New scan</span>
        </button>
      </div>`;
  }
}

function finishStopped() {
  scanning = false;
  setDot('stop', t('detenido', 'stopped'));
  document.getElementById('btn-stop').style.display  = 'none';
  document.getElementById('btn-reset').style.display = 'flex';
  feedLine(t('— Escaneo detenido por el usuario —', '— Scan stopped by user —'), 'info');
}

// ══════════════════════════════════════════════════════
//  COLLECT — File System Access API
//  TAREA 3: respeta userIgnoreFolders + userMinFileSize
// ══════════════════════════════════════════════════════
async function collect(dh, path) {
  for await (const [name, handle] of dh.entries()) {
    if (cancelled) return;
    const fullPath = path + '/' + name;
    if (handle.kind === 'directory') {
      if (isBlocked(fullPath) || isUserIgnored(name)) {
        feedLine('✗  ' + name + '  [' + t('omitida', 'skipped') + ']', 'skip');
        skipCount++;
        await frame();
        continue;
      }
      feedLine('▸  ' + fullPath, 'dir');
      await frame();
      await collect(handle, fullPath);
    } else {
      try {
        const file = await handle.getFile();
        // Filtro por tamaño mínimo
        if (file.size < userMinFileSize) continue;
        feedLine('   ' + name, 'file');
        FILES.set(fullPath, { handle, size: file.size, name, dir: path, hash: null, _sid: null, canDelete: true });
        fileCount++;
        document.getElementById('scan-cnt').textContent = fileCount + ' ' + t('archivos', 'files');
      } catch {}
      if (fileCount % 15 === 0) await frame();
    }
  }
}

// ══════════════════════════════════════════════════════
//  COLLECT — <input webkitdirectory> fallback
//  TAREA 3: respeta userIgnoreFolders + userMinFileSize
// ══════════════════════════════════════════════════════
async function collectFromInput(files) {
  const seenDirs = new Set();
  for (let i = 0; i < files.length; i++) {
    if (cancelled) return;
    const file  = files[i];
    const rel   = file.webkitRelativePath;
    const parts = rel.split('/');
    const name  = parts[parts.length - 1];
    const dir   = parts.slice(0, -1).join('/');

    // Verificar si algún segmento de la ruta está bloqueado por sistema o usuario
    if (parts.some(p => BLOCKED.has(p.toLowerCase()) || isUserIgnored(p))) {
      skipCount++;
      continue;
    }
    // Filtro por tamaño mínimo
    if (file.size < userMinFileSize) continue;

    if (!seenDirs.has(dir)) { seenDirs.add(dir); feedLine('▸  ' + dir, 'dir'); }
    feedLine('   ' + name, 'file');
    FILES.set(rel, { fileObj: file, handle: null, size: file.size, name, dir, hash: null, _sid: null, canDelete: false });
    fileCount++;
    document.getElementById('scan-cnt').textContent = fileCount + ' ' + t('archivos', 'files');
    if (fileCount % 30 === 0) await frame();
  }
}

// ══════════════════════════════════════════════════════
//  FIND DUPLICATES
// ══════════════════════════════════════════════════════
async function findDupes() {
  const bySize = new Map();
  for (const [key, fi] of FILES) {
    if (!bySize.has(fi.size)) bySize.set(fi.size, []);
    bySize.get(fi.size).push({ key, ...fi });
  }
  const candidates = [...bySize.values()].filter(g => g.length > 1);
  const total = candidates.reduce((s, g) => s + g.length, 0);
  if (total === 0) return;

  feedLine('─────────────────────────────', 'info');
  feedLine('SHA-256: ' + total + ' ' + t('candidatos por tamaño', 'size-matched candidates'), 'info');
  if (userHashStrategy === 'sample') {
    feedLine(t('⚡ Modo muestras activo para archivos > 20 MB',
               '⚡ Sampling mode active for files > 20 MB'), 'info');
  }
  await frame();

  let done = 0;
  const $pbar = document.getElementById('pbar');
  for (const group of candidates) {
    if (cancelled) return;
    for (const fi of group) {
      if (cancelled) return;
      feedLine('  ⚡ ' + fi.name, 'file');
      const hash = await sha256(fi);
      if (!hash) { done++; continue; }
      fi.hash = hash;
      if (FILES.has(fi.key)) FILES.get(fi.key).hash = hash;
      if (!GROUPS.has(hash)) GROUPS.set(hash, []);
      GROUPS.get(hash).push(fi);
      if (GROUPS.get(hash).length >= 2) {
        feedLine('💥 ' + t('DUPLICADO', 'DUPLICATE') + ': ' + fi.name, 'match');
        renderGroup(hash);
        await frame();
      }
      done++;
      $pbar.style.width = Math.round(done / total * 100) + '%';
      updateStats();
    }
  }
}

// ══════════════════════════════════════════════════════
//  RENDER GROUP
// ══════════════════════════════════════════════════════
function renderGroup(hash) {
  const files = GROUPS.get(hash);
  if (!files || files.length < 2) return;
  document.getElementById('grp-' + hash)?.remove();

  const ext = files[0].name.includes('.') ? files[0].name.split('.').pop().toLowerCase() : '';
  const el  = document.createElement('div');
  el.className = 'dg'; el.id = 'grp-' + hash; el.dataset.ext = ext;

  el.innerHTML = `
    <div class="dg-hdr">
      <span>
        <span class="h">${hash.substring(0, 14)}…</span>
        &nbsp;·&nbsp;
        ${files.length} ${t('copias idénticas', 'identical copies')}
        &nbsp;·&nbsp;
        ${fmtSize(files[0].size)} ${t('c/u', 'each')}
        ${ext ? `&nbsp;·&nbsp; <span style="color:var(--muted)">.${ext}</span>` : ''}
      </span>
      <span class="sv" title="${t('espacio recuperable al borrar las copias', 'space freed by deleting copies')}">
        ↩ ${fmtSize(files[0].size * (files.length - 1))}
      </span>
    </div>`;

  files.forEach((fi, i) => {
    const isOrig    = i === 0;
    const canDelete = !limitedMode && fi.canDelete !== false;
    let h = 5381;
    for (let j = 0; j < fi.key.length; j++) h = ((h << 5) + h) ^ fi.key.charCodeAt(j);
    const sid = 'r' + (h >>> 0).toString(36);
    fi._sid = sid;
    if (FILES.has(fi.key)) FILES.get(fi.key)._sid = sid;

    const row      = document.createElement('div');
    row.className  = 'df' + (isOrig ? ' orig' : '');
    row.id         = sid;
    const keyEsc   = fi.key.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    const chkTitle = isOrig
      ? t('Original: no se puede eliminar', 'Original: cannot be deleted')
      : t('Solo lectura en este navegador', 'Read-only in this browser');
    const chkAttr  = (isOrig || !canDelete) ? `disabled title="${chkTitle}"` : '';

    row.innerHTML = `
      <input type="checkbox" ${chkAttr} onchange="toggleSel('${keyEsc}',this.checked)">
      <i class="${getIcon(fi.name)} df-icon"></i>
      <div class="df-info">
        <div class="df-name">${fi.name}${isOrig ? `<span class="orig-tag">${t('original', 'original')}</span>` : ''}</div>
        <div class="df-path">${fi.dir}</div>
      </div>
      <button class="btn-eye" onclick="previewFile('${keyEsc}')" title="${t('Vista previa', 'Preview')}">
        <i class="fas fa-eye"></i>
      </button>`;
    el.appendChild(row);
  });

  document.getElementById('dupes-scroll').appendChild(el);
  addExtToFilter(ext);
  if (activeFilters.size > 0 && !activeFilters.has(ext)) el.style.display = 'none';
  updateStats();

  const n = [...GROUPS.values()].filter(g => g.length > 1).length;
  const badge = document.getElementById('dupe-badge');
  badge.textContent = n;
  badge.classList.toggle('z', n === 0);
}

// ══════════════════════════════════════════════════════
//  SELECTION
// ══════════════════════════════════════════════════════
function toggleSel(key, checked) {
  if (limitedMode) return;
  checked ? SEL.add(key) : SEL.delete(key);
  const fi = FILES.get(key);
  if (fi && fi._sid) document.getElementById(fi._sid)?.classList.toggle('sel', checked);
  updateSelectionUI();
}

function selectAll() {
  if (limitedMode) return;
  for (const [, files] of GROUPS) {
    if (files.length < 2) continue;
    files.forEach((fi, i) => {
      if (i === 0 || SEL.has(fi.key)) return;
      SEL.add(fi.key);
      if (fi._sid) {
        const row = document.getElementById(fi._sid);
        if (row) {
          row.classList.add('sel');
          const cb = row.querySelector('input[type=checkbox]');
          if (cb) cb.checked = true;
        }
      }
    });
  }
  updateSelectionUI();
}

function deselectAll() {
  for (const key of [...SEL]) {
    const fi = FILES.get(key);
    if (fi && fi._sid) {
      const row = document.getElementById(fi._sid);
      if (row) {
        row.classList.remove('sel');
        const cb = row.querySelector('input[type=checkbox]');
        if (cb) cb.checked = false;
      }
    }
  }
  SEL.clear();
  updateSelectionUI();
}

function getSelectedSize() {
  let total = 0;
  for (const key of SEL) { const fi = FILES.get(key); if (fi) total += fi.size; }
  return total;
}

function updateSelectionUI() {
  const n    = SEL.size;
  const size = getSelectedSize();
  document.getElementById('btn-del').style.display = (!limitedMode && n > 0) ? 'block' : 'none';
  document.getElementById('sel-cnt').textContent   = n;
  const infoEl = document.getElementById('sel-info');
  if (n === 0) {
    infoEl.style.display = 'none';
  } else {
    const label = n === 1
      ? t('1 archivo seleccionado', '1 file selected')
      : t(n + ' archivos seleccionados', n + ' files selected');
    infoEl.textContent   = '▶ ' + label + ' · ' + fmtSize(size);
    infoEl.style.display = 'inline';
  }
}

// ══════════════════════════════════════════════════════
//  STATISTICS
// ══════════════════════════════════════════════════════
function updateStats() {
  document.getElementById('st-files').textContent = fileCount;
  const gs = [...GROUPS.values()].filter(g => g.length > 1);
  const w  = gs.reduce((s, g) => s + g[0].size * (g.length - 1), 0);
  document.getElementById('st-size').textContent = w > 0 ? fmtSize(w) : '—';
  const badge = document.getElementById('dupe-badge');
  badge.textContent = gs.length;
  badge.classList.toggle('z', gs.length === 0);
}

// ══════════════════════════════════════════════════════
//  TAREA 3 — PREVIEW con soporte nativo VÍDEO y AUDIO
//  Usa URL.createObjectURL() para crear una URL temporal
//  sin copiar el archivo en RAM para reproducirlo.
// ══════════════════════════════════════════════════════
async function previewFile(key) {
  const fi = FILES.get(key);
  if (!fi) return;

  document.getElementById('prev-empty').style.display     = 'none';
  document.getElementById('btn-close-prev').style.display = 'block';
  const $c = document.getElementById('prev-content');
  $c.style.display = 'block';
  document.getElementById('prev-lbl').textContent = fi.name;

  $c.innerHTML = `
    <div style="margin-bottom:12px;">
      <div class="pv-name">${fi.name}</div>
      <div class="pv-meta">${fi.dir} &nbsp;·&nbsp; <span class="ac">${fmtSize(fi.size)}</span></div>
    </div>
    <div id="pv-loading" style="color:var(--dim);font-family:'Fira Code',monospace;font-size:.72rem;text-align:center;padding:20px;">
      ${t('Cargando…', 'Loading…')}
    </div>`;

  // En móvil, hacer scroll hasta el panel de preview
  if (window.innerWidth <= 768) {
    document.getElementById('panel-right').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  try {
    const file = fi.fileObj ? fi.fileObj : await fi.handle.getFile();
    document.getElementById('pv-loading')?.remove();

    if (isImg(fi.name)) {
      // ── Imagen ──
      const url  = URL.createObjectURL(file);
      const wrap = document.createElement('div');
      wrap.style.cssText = 'text-align:center;';
      const img  = document.createElement('img');
      img.style.cssText = 'max-width:100%;max-height:calc(100vh - 160px);border-radius:4px;border:1px solid var(--border);display:block;margin:0 auto;';
      img.src = url; img.alt = fi.name;
      img.onload = () => URL.revokeObjectURL(url);
      wrap.appendChild(img); $c.appendChild(wrap);

    } else if (isVideo(fi.name)) {
      // ── Vídeo nativo — TAREA 3 ──
      const url   = URL.createObjectURL(file);
      const video = document.createElement('video');
      video.controls = true;
      video.preload  = 'metadata';
      video.style.cssText = 'max-width:100%;max-height:calc(100vh - 200px);border-radius:4px;border:1px solid var(--border);display:block;margin:0 auto;background:#000;';
      video.src = url;
      // Liberar URL cuando el elemento se descargue o falle
      video.addEventListener('error', () => URL.revokeObjectURL(url), { once: true });
      $c.appendChild(video);
      const note = document.createElement('div');
      note.style.cssText = 'font-family:"Fira Code",monospace;font-size:.6rem;color:var(--muted);margin-top:7px;text-align:right;';
      note.textContent = '.' + fi.name.split('.').pop().toLowerCase() + ' · ' + fmtSize(fi.size);
      $c.appendChild(note);

    } else if (isAudio(fi.name)) {
      // ── Audio nativo — TAREA 3 ──
      const url   = URL.createObjectURL(file);
      const wrap  = document.createElement('div');
      wrap.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:16px;padding:28px 14px;text-align:center;';
      const ico   = document.createElement('i');
      ico.className = getIcon(fi.name);
      ico.style.cssText = 'font-size:3rem;color:var(--dim);';
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.preload  = 'metadata';
      audio.style.cssText = 'width:100%;max-width:270px;';
      audio.src = url;
      audio.addEventListener('error', () => URL.revokeObjectURL(url), { once: true });
      const note = document.createElement('div');
      note.style.cssText = 'font-family:"Fira Code",monospace;font-size:.62rem;color:var(--muted);';
      note.textContent = '.' + fi.name.split('.').pop().toLowerCase() + ' · ' + fmtSize(fi.size);
      wrap.appendChild(ico); wrap.appendChild(audio); wrap.appendChild(note);
      $c.appendChild(wrap);

    } else if (isTxt(fi.name) && fi.size < 1048576) {
      // ── Texto ──
      const text = await file.text();
      const ext  = fi.name.includes('.') ? fi.name.split('.').pop().toLowerCase() : '';
      const pre  = document.createElement('pre');
      pre.style.cssText = `font-family:'Fira Code',monospace;font-size:.72rem;line-height:1.65;color:var(--white);background:var(--code-bg);padding:12px;border-radius:4px;border:1px solid var(--border);white-space:pre-wrap;word-break:break-all;max-height:calc(100vh - 160px);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--red) transparent;`;
      pre.textContent = text.length > 12000 ? text.substring(0, 12000) + '\n… (' + t('truncado', 'truncated') + ')' : text;
      $c.appendChild(pre);
      const note = document.createElement('div');
      note.style.cssText = 'font-family:"Fira Code",monospace;font-size:.6rem;color:var(--muted);margin-top:5px;text-align:right;';
      note.textContent = (ext ? '.' + ext : t('sin extensión', 'no ext')) + ' · ' + fmtSize(fi.size);
      $c.appendChild(note);

    } else if (fi.name.toLowerCase().endsWith('.pdf')) {
      // ── PDF ──
      const url   = URL.createObjectURL(file);
      const embed = document.createElement('embed');
      embed.src   = url; embed.type = 'application/pdf';
      embed.style.cssText = 'width:100%;height:calc(100vh - 160px);border:1px solid var(--border);border-radius:4px;';
      $c.appendChild(embed);

    } else {
      // ── Archivo binario genérico ──
      const ext = fi.name.includes('.') ? fi.name.split('.').pop().toUpperCase() : t('SIN EXT', 'NO EXT');
      const d   = document.createElement('div');
      d.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:14px;padding:28px 16px;text-align:center;';
      d.innerHTML = `
        <i class="${getIcon(fi.name)}" style="font-size:3.5rem;color:var(--dim);"></i>
        <div style="font-size:1rem;font-weight:700;color:var(--white);">.${ext.toLowerCase()}</div>
        <div style="font-size:1.35rem;font-weight:700;color:var(--red);">${fmtSize(fi.size)}</div>
        <div style="font-family:'Fira Code',monospace;font-size:.63rem;color:var(--muted);max-width:220px;line-height:1.7;">
          ${t(
            'Archivo binario — sin previsualización.<br>Contenido byte a byte idéntico al del resto de copias (mismo SHA-256).',
            'Binary file — no preview available.<br>Content is byte-for-byte identical to all other copies (same SHA-256).'
          )}
        </div>`;
      $c.appendChild(d);
    }
  } catch (e) {
    document.getElementById('pv-loading')?.remove();
    $c.innerHTML += `<div style="color:var(--red);font-size:.72rem;font-family:'Fira Code',monospace;margin-top:8px;">${t('Error al cargar', 'Error loading')}: ${e.message}</div>`;
  }
}

function closePreview() {
  document.getElementById('prev-content').style.display   = 'none';
  document.getElementById('prev-empty').style.display     = 'flex';
  document.getElementById('btn-close-prev').style.display = 'none';
  document.getElementById('prev-lbl').textContent         = '';
  // Revocar posibles object URLs activas liberando RAM
  const video = document.querySelector('#prev-content video');
  const audio = document.querySelector('#prev-content audio');
  if (video?.src?.startsWith('blob:')) URL.revokeObjectURL(video.src);
  if (audio?.src?.startsWith('blob:')) URL.revokeObjectURL(audio.src);
}

// ══════════════════════════════════════════════════════
//  STATUS DOT
// ══════════════════════════════════════════════════════
function setDot(state, label) {
  document.getElementById('scan-dot').className   = 'dot d-' + state;
  document.getElementById('scan-lbl').textContent = label;
}

function stopScan() { cancelled = true; }

// ══════════════════════════════════════════════════════
//  RESET
// ══════════════════════════════════════════════════════
function resetApp() {
  cancelled = true; scanning = false; limitedMode = false;
  dirHandle = null; FILES.clear(); GROUPS.clear(); SEL.clear();
  fileCount = 0; skipCount = 0; feedCount = 0;
  activeFilters.clear(); detectedExts.clear();
  document.getElementById('mobile-input').value = '';

  const fb = document.getElementById('filter-bar');
  fb.classList.remove('visible');
  fb.querySelectorAll('.fmt-chip:not(.all)').forEach(c => c.remove());
  fb.querySelector('.fmt-chip.all')?.classList.add('active');

  const limitedWarnVisible = !hasFSAPI();
  document.getElementById('dupes-scroll').innerHTML = `
    <div id="home">
      <div class="home-icon"><i class="fas fa-copy"></i></div>
      <h2>DupeCleaner</h2>
      <p class="es">Selecciona una carpeta — Descargas, Documentos, donde quieras. La app la escanea con SHA-256 y te muestra los archivos con contenido exactamente idéntico.</p>
      <p class="en">Select any folder — Downloads, Documents, wherever. The app scans it with SHA-256 and shows files with exactly identical content.</p>
      <button class="btn-primary" onclick="pickFolder()">
        <i class="fas fa-folder-open"></i>
        <span class="es">Seleccionar carpeta</span><span class="en">Select folder</span>
      </button>
      <p class="home-note" id="compat-note"></p>
      <div id="limited-warn" style="${limitedWarnVisible ? 'display:block;' : 'display:none;'}" class="home-warn">
        <span class="es"><i class="fas fa-circle-info"></i> Tu navegador no permite eliminar archivos desde la web.<br>El escaneo funciona con total normalidad, pero para borrar duplicados necesitas <strong>Chrome o Edge</strong> (escritorio o Android).</span>
        <span class="en"><i class="fas fa-circle-info"></i> Your browser doesn't allow deleting files from the web.<br>Scanning works fine, but to delete duplicates you need <strong>Chrome or Edge</strong> (desktop or Android).</span>
      </div>
    </div>
    <div id="confirm-step" style="display:none;"></div>`;

  $feed.innerHTML = `
    <div id="feed-ph" style="height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--dim);font-size:.75rem;text-align:center;pointer-events:none;font-family:'Fira Code',monospace;">
      <i class="fas fa-terminal" style="font-size:1.8rem;"></i>
      <span class="es">El registro aparecerá<br>aquí durante el escaneo</span>
      <span class="en">The log will appear<br>here during the scan</span>
    </div>`;

  setDot('idle', t('inactivo', 'idle'));
  document.getElementById('scan-cnt').textContent          = '';
  document.getElementById('pbar').style.width              = '0%';
  document.getElementById('dupe-badge').textContent        = '0';
  document.getElementById('dupe-badge').classList.add('z');
  document.getElementById('btn-del').style.display         = 'none';
  document.getElementById('btn-stop').style.display        = 'none';
  document.getElementById('btn-reset').style.display       = 'none';
  document.getElementById('nav-folder').style.display      = 'none';
  document.getElementById('prev-empty').style.display      = 'flex';
  document.getElementById('prev-content').style.display    = 'none';
  document.getElementById('btn-close-prev').style.display  = 'none';
  document.getElementById('prev-lbl').textContent          = '';
  // Resetear toggle de feed móvil
  document.getElementById('panel-left').classList.remove('mobile-open');
  document.getElementById('mobile-feed-btn').classList.remove('feed-visible');
  updateStats(); updateSelectionUI(); updateCompatNote();
}

// ══════════════════════════════════════════════════════
//  DELETE MODAL
// ══════════════════════════════════════════════════════
function openModal() {
  if (limitedMode) return;
  const list = document.getElementById('modal-list');
  list.innerHTML = '';
  for (const key of SEL) {
    const fi = FILES.get(key);
    if (fi) {
      const d = document.createElement('div');
      d.textContent = fi.dir + '/' + fi.name;
      list.appendChild(d);
    }
  }
  document.getElementById('modal-input').value    = '';
  document.getElementById('btn-confirm').disabled = true;
  document.getElementById('modal-ov').classList.add('on');
}

function checkConfirm(v) {
  document.getElementById('btn-confirm').disabled = v !== t('CONFIRMAR', 'CONFIRM');
}

function closeModal() { document.getElementById('modal-ov').classList.remove('on'); }

async function execDelete() {
  if (limitedMode) return;
  closeModal();
  for (const key of [...SEL]) {
    const fi = FILES.get(key);
    if (!fi || !fi.handle) continue;
    try {
      await fi.handle.remove();
      feedLine('🗑  ' + t('Eliminado', 'Deleted') + ': ' + fi.name, 'match');
      if (fi._sid) document.getElementById(fi._sid)?.remove();
      FILES.delete(key); SEL.delete(key);
    } catch (e) {
      feedLine('✗  ' + t('Error al eliminar', 'Delete error') + ': ' + fi.name + ' — ' + e.message, 'err');
    }
  }
  updateStats(); updateSelectionUI();
}
</script>
</body>
</html>
